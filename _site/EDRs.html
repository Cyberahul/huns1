<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/EDRs.html" />
<meta property="og:url" content="http://localhost:4000/EDRs.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/EDRs.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="edrs">EDRs</h1>

<p>Llego el momento, a partir de este momento nos enfrentaremos a los EDRs. Esa temida herramienta de software que bloquea y alerta nustros intentos de realizar pentesting sobre uno o varios sistemas operativos.
Por lo tanto ser√° indispensable a la hora de enfrentarnos a este tipo de softwares, saber que son y que hacen:</p>

<h3 id="que-son-los-edrs">¬øQue son los EDRs?</h3>

<p><code class="language-plaintext highlighter-rouge">EDR</code> ‚ÄúEndpoint Detection Response‚Äù: Existen infinidad de definiciones que se pueden encontrar con una simple consulta en Google, que traduciendo a un lenguaje coloquial, lo puedo resumir con mis propias palabras:</p>

<p>Se trata de un software que realiza una evoluci√≥n de los antivirus tradicionales, dando una capa superior de seguridad al sistema en el que se ejecuta.
Por lo general se trata de un software centralizado, en el que en cada sistema instala un agente al que se le puede denominar <code class="language-plaintext highlighter-rouge">Endpoint</code> que tiene privilegios de administraci√≥n sobre el sistema en el que ejecuta y por tanto la posibilidad de Monitorizar, Detectar, Alertar y ejecutar acciones en el activo en el que se encuentra instalado como contener un equipo, matar procesos o borrar archivos.</p>

<p><img src="/assets/images/EDR_diagram.png" alt="EDR" /></p>

<h3 id="que-hacen-los-edrs">¬øQue hacen los EDRs?</h3>

<p>La funci√≥n final de los EDRs es la de garantizar una seguridad completa en los activos de una empresa frente a todo tipo de amenazas. <code class="language-plaintext highlighter-rouge">O almenos as√≠ los venden</code>, ¬øRealizan esta funci√≥n?, absolutamente no.
Las funciones que realizan los EDRs ser√°n las siguientes:</p>
<ul>
  <li>Funciones de los <code class="language-plaintext highlighter-rouge">EPP</code> ‚ÄúEndpoint Protection Platform‚Äù dando la capacidad al agente de:</li>
  <li>Antivirus</li>
  <li>Antimalware</li>
  <li>Previsi√≥n de Intrusi√≥n <code class="language-plaintext highlighter-rouge">IPS</code></li>
  <li>Prevenci√≥n de perdida de datos <code class="language-plaintext highlighter-rouge">DLP</code></li>
  <li>Prevenci√≥n de ejecuci√≥n de exploits</li>
  <li>Basando las ejecuciones en firmas</li>
  <li>Ademas por ser EDRs desde el sw centralizado del servidor:</li>
  <li>MachingLearning y anal√≠ticas de binarios y ejecuciones</li>
  <li>Sandboxing de binarios escritos en disco y ejecutados en los sistemas</li>
  <li>Investigaci√≥n de incidentes</li>
  <li>Herramientas de contenci√≥n y respuesta ante incidentes</li>
</ul>

<p>Y bastantes cosas m√°s, inteligencia, actores, APTs, etc. (por no ser criticado por los fabricantes).</p>

<h2 id="tipos-de-edr">Tipos De EDR</h2>

<p>En este punto y de cara a nuestro estudio trabajaremos con dos tipos de EDRs:</p>
<ul>
  <li>EDR comercial: nuestro objtivo ser√° crowdstrike</li>
  <li>EDR no comercial: (Magia negra)</li>
</ul>

<h2 id="edr-comercial">EDR comercial</h2>

<p>De cara a pruebas finales como objetivo de mi investigaci√≥n, el bypass lo llevar√© dirigido a Crowdstrike como EDR comercial. Del cual me estoy certificando como Hunter (certificaci√≥n que he dejado a medias por aburrimiento, mis disculpas ¬°Espero encontrar las ganas para finalizarla en breves!)</p>

<p><a href="https://www.crowdstrike.com/en-us/">crowdstrike</a></p>

<p>Si estais interesados aqui va la versi√≥n gratuita de 15 d√≠as:</p>

<p><a href="https://www.crowdstrike.com/products/trials/try-falcon-prevent/?utm_campaign=brand&amp;utm_content=crwd-treq-en-x-tct-es-psp-x-trl-brnd-x_x_x_x-core&amp;utm_medium=sem&amp;utm_source=goog&amp;utm_term=crowdstrike&amp;cq_cmp=19634286413&amp;cq_plac=&amp;gad_source=1&amp;gclid=EAIaIQobChMIqbiCiqyygwMVl8HVCh0SOwpfEAAYASABEgLHMvD_BwE">free for 15 days</a></p>

<h2 id="edr-no-comercial">EDR no comercial</h2>

<p>De cara al estudio del malware, trabajaremos con el sigiuente proyecto de Github <code class="language-plaintext highlighter-rouge">Best EDR Of The Market</code>:</p>

<p><a href="https://xacone.github.io/BestEdrOfTheMarket.html">Introduction BETOM</a></p>

<p><a href="https://github.com/Xacone/BestEdrOfTheMarket">Github BETOM</a></p>

<p>De facil instalaci√≥n y ejecuci√≥n en nuestra m√°quina.</p>

<ul>
  <li>Especial agradecimiento a @Xacone : Yazid Benjamaa</li>
  <li>Os dejo su linkedin: <a href="https://www.linkedin.com/in/yazid-benjamaa/">Yaizd</a></li>
</ul>

<h2 id="pruebas-de-nuestro-c√≥digo">Pruebas de nuestro c√≥digo</h2>

<p>Los ejercicios de nuestro post actual, se centrar√°n en evaluar los binarios o ejecutables obtenidos en la etapa anterior sobre los tipos de inyecciones de shellcode entre procesos dentro de un sistema operativo.</p>

<p>Una vez descargada la √∫ltima Release disponible de BETOM, e instaladas sus dependencias sobre el sistema operativo, podremos ejecutar el binario del siguiente modo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\IEUser\Downloads\BestEdrOfTheMarket-1.0.0-Win64\BestEdrOfTheMarket&gt;BestEdrOfTheMarket.exe /help
[0;38;2;135;206;250m ____            _     _____ ____  ____     ___   __   _____ _
| __ )  ___  ___| |_  | ____|  _ \|  _ \   / _ \ / _| |_   _| |__   ___
|  _ \ / _ \/ __| __| |  _| | | | | |_) | | | | | |_    | | | '_ \ / _ \
| |_) |  __/\__ \ |_  | |___| |_| |  _ &lt;  | |_| |  _|   | | | | | |  __/
|____/_\___||___/\__| |_____|____/|_| \_\  \___/|_|     |_| |_| |_|\___|
|  \/  | __ _ _ __| | _____| |_
| |\/| |/ _` | '__| |/ / _ \ __|
| |  | | (_| | |  |   &lt;  __/ |_           Yazidou - github.com/Xacone
|_|  |_|\__,_|_|  |_|\_\___|\__|
[0m
                [0;38;2;128;0;32mhttps://github.com/Xacone/BestEdrOfTheMarket[0m

        Usage: BestEdrOfTheMarket.exe [args]

                 /help : Shows this help message and exits
                 /v Verbosity

                 /iat IAT hooking
                 /stack threds call stack monitoring
                 /nt Inline Nt-level hooking
                 /k32 Inline Kernel32/Kernelbase hooking
                 /ssn SSN crushing

</code></pre></div></div>

<p>Para monitorizar los procesos de lo binarios trabajaremos con los siguienets par√°metros:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\IEUser\Downloads\BestEdrOfTheMarket-1.0.0-Win64\BestEdrOfTheMarket&gt;BestEdrOfTheMarket.exe /v /iat /stack
 ____            _     _____ ____  ____     ___   __   _____ _
| __ )  ___  ___| |_  | ____|  _ \|  _ \   / _ \ / _| |_   _| |__   ___
|  _ \ / _ \/ __| __| |  _| | | | | |_) | | | | | |_    | | | '_ \ / _ \
| |_) |  __/\__ \ |_  | |___| |_| |  _ &lt;  | |_| |  _|   | | | | | |  __/
|____/_\___||___/\__| |_____|____/|_| \_\  \___/|_|     |_| |_| |_|\___|
|  \/  | __ _ _ __| | _____| |_
| |\/| |/ _` | '__| |/ / _ \ __|
| |  | | (_| | |  |   &lt;  __/ |_           Yazidou - github.com/Xacone
|_|  |_|\__,_|_|  |_|\_\___|\__|

                        My PID is 5656

[*] Choose the PID to monitor :
</code></pre></div></div>
<p>Dentro de <a href="./injection_types.html">tipos de inyecci√≥n</a>, encontraremos el c√≥digo de los binarios que vamos a analizar en tiempo de ejecuci√≥n:</p>

<h1 id="indice">Indice</h1>

<ol>
  <li><a href="./external_process_injection.html">Inyecci√≥n en proceso externo</a></li>
  <li><a href="./external_process_thread_injection.html">Inyecci√≥n en hilo del proceso externo</a></li>
  <li><a href="./shared_memory_sections_views.html">Inyecci√≥n por memoria compartida</a></li>
  <li><a href="./asynchronous_procedure_calls.html">Inyecci√≥n por llamada as√≠ncrona</a></li>
  <li><a href="./Earlybird.html">Inyeccion creaci√≥n de proceso en suspensi√≥n (Earlybird)</a></li>
</ol>

<h3 id="betom-inyecci√≥n-en-proceso-externo">BETOM Inyecci√≥n en proceso externo:</h3>

<p>Realizaremos un cambio en el c√≥digo fuente para los ejecutables EXE, que nos permitira identicar en tiempo de ejecuci√≥n el Pid del proceso que se encuentra realizando la inyecci√≥n en tiempo real dentro del sistema operativo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">lpid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[main] Init program %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lpid</span><span class="p">);</span>
<span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>

<p><img src="/assets/images/EDR_injection_1.png" alt="EDR inejction 1" /></p>

<p>Como se puede apreciar tras apretar intro en el binario malicioso el EDR monitoriza a traves de su stack una iyecci√≥n:</p>

<p><img src="/assets/images/EDR_injection_1_detect.png" alt="EDR inejction 1" /></p>

<p><code class="language-plaintext highlighter-rouge">El EDR, ha alertado y parado su ejecuci√≥n</code>.</p>

<p>Ahora revisaremos la misma versi√≥n del binario desde una DLL ejecutable, como no es posible en este caso pintar el pid del proceso se utilizar√° la siguiente t√©cnica para poder analizar su ejecuci√≥n:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="n">Sleep</span><span class="p">(</span><span class="mi">20000</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div></div>
<p>En el inicio del proceso se a√±adir√° un delay de 20 segundos, que nos pemirtira buscarlo con ProcessHacker y poner BETOM en su monitorizaci√≥n:</p>

<p><img src="/assets/images/EDR_1_processhacker.png" alt="EDR inejction 1" /></p>

<p>En este punto tendr√≠amos dos pids de proceso a monitorizar:</p>

<ol>
  <li>Binario o DLL maliciosa con PID del proceso:</li>
  <li>notepad.exe que ser√° el proceso destino en el que se realizar√° la inyecci√≥n:</li>
</ol>

<ul>
  <li>Ocurrir√°n dos cosas, el EDR matar√° el proceso malicioso : rundll32.exe base_injection_exec.dll,f0ns1</li>
  <li>Dado que la inyecci√≥n se ha realizado en el proceso notepad.exe, se ejecutar√° la calculadora</li>
</ul>

<p><img src="/assets/images/EDR_injection_1_calc.png" alt="EDR inejction 1" /></p>

<p>A nivel Crowdstrike, no nos permite escribir en disco la Dll, por lo que no ser√° posible ejecutarla.</p>

<h3 id="betom-inyecci√≥n-en-hilo-del-proceso-externo">BETOM Inyecci√≥n en hilo del proceso externo:</h3>

<p>Realizaremos un cambio en el c√≥digo fuente para los ejecutables EXE, que nos permitira identicar en tiempo de ejecuci√≥n el Pid del proceso que se encuentra realizando la inyecci√≥n en tiempo real dentro del sistema operativo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">lpid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[main] Init program %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lpid</span><span class="p">);</span>
<span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>

<p>Durante la ejecuci√≥n del proceso podemos ver las siguientes detecciones:</p>

<p><img src="/assets/images/EDR_2_BETOM_1.png" alt="EDR inejction hilo" /></p>

<h3 id="betom-inyecci√≥n-por-memoria-compartida">BETOM Inyecci√≥n por memoria compartida:</h3>

<p>Realizaremos un cambio en el c√≥digo fuente para los ejecutables EXE, que nos permitira identicar en tiempo de ejecuci√≥n el Pid del proceso que se encuentra realizando la inyecci√≥n en tiempo real dentro del sistema operativo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">lpid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[main] Init program %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lpid</span><span class="p">);</span>
<span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>

<p>Durante la ejecuci√≥n del proceso podemos ver las siguientes detecciones:</p>

<p><img src="/assets/images/EDR_shared_memory_1.png" alt="EDR Shared memory 1" /></p>

<p>El EDR detecta la apertura de un proceso externo:</p>

<p><img src="/assets/images/EDR_shared_memory_2.png" alt="EDR Shared memory 2" /></p>

<p>El EDR detecta la inyecci√≥n y finalmente mata la ejecuci√≥n del proceso:</p>

<p><img src="/assets/images/EDR_shared_memory_3.png" alt="EDR Shared memory 3" /></p>

<h3 id="betom-inyecci√≥n-por-llamada-asincrona-apc">BETOM Inyecci√≥n por llamada asincrona APC:</h3>

<p>Realizaremos un cambio en el c√≥digo fuente para los ejecutables EXE, que nos permitira identicar en tiempo de ejecuci√≥n el Pid del proceso que se encuentra realizando la inyecci√≥n en tiempo real dentro del sistema operativo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">lpid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[main] Init program %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lpid</span><span class="p">);</span>
<span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>

<p>Durante la ejecuci√≥n del proceso podemos ver las siguientes detecciones:</p>

<p><img src="/assets/images/EDR_AsyncCalls.png" alt="EDR Asynchronous Process Call 1" /></p>

<p>El EDR detecta la apertura de un proceso externo:</p>

<p><img src="/assets/images/EDR_AsyncCalls_1.png" alt="EDR Asynchronous Process Call 2" /></p>

<p>El EDR detecta la reserva de memoria en el proceso externo para escribir nuestro shellcode:</p>

<p><img src="/assets/images/EDR_AsyncCalls_2.png" alt="EDR Asynchronous Process Call 3" /></p>

<p>El EDR detecta la escritura del shellcode en el proceso remoto:</p>

<p><img src="/assets/images/EDR_AsyncCalls_3.png" alt="EDR Asynchronous Process Call 3" /></p>

<p>El EDR detecta que se libera memoria, indica que nuestro proceso ha terminado:</p>

<p><img src="/assets/images/EDR_AsyncCalls_6.png" alt="EDR Asynchronous Process Call 3" /></p>

<p>Dado que la llamada APC se ha encolado cuando, el usuario trata de guardar el documento de notepad abierto, la inyecci√≥n encolada por APC se ejecuta.</p>

<p><img src="/assets/images/EDR_AsyncCalls_bypass1.png" alt="EDR Asynchronous Process Call 3" /></p>

<h3 id="betom-inyecci√≥n-por-creaci√≥n-de-proceso-en-suspensi√≥n-earlybird">BETOM Inyecci√≥n por creaci√≥n de proceso en suspensi√≥n (Earlybird):</h3>

<p>Realizaremos un cambio en el c√≥digo fuente para los ejecutables EXE, que nos permitira identicar en tiempo de ejecuci√≥n el Pid del proceso que se encuentra realizando la inyecci√≥n en tiempo real dentro del sistema operativo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">lpid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[main] Init program %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lpid</span><span class="p">);</span>
<span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>
<p>Con este tipo de inyecci√≥n han sido necesarias varias ejecuciones para validar la detecci√≥n por parte del EDR:</p>

<p><img src="/assets/images/EDR_Earlybird_1.png" alt="EDR Earlybird " /></p>

<p>Se detecta obtenci√≥n del proceso actual:</p>

<p><img src="/assets/images/EDR_Earlybird_2.png" alt="EDR Earlybird " /></p>

<ul>
  <li>Ejecuci√≥n 1:
<img src="/assets/images/EDR_Earlybird_3.png" alt="EDR Earlybird " /></li>
  <li>Ejecuci√≥n 2:
<img src="/assets/images/EDR_earlybird_2.png" alt="EDR Earlybird " /></li>
</ul>

<h3 id="conclusiones">Conclusiones</h3>

<p>Nuestro c√≥digo, es alertado en todas las ocasiones de una manera u otro el motivo de esta alerta es el uso de las librer√≠as DLL kernel32.dll, ntdll.dll, AdvApi32.dll que se encuentran hookeadas y monitorizadas por el EDR.</p>

<p><img src="/assets/images/EDR_dll_hooking.png" alt="EDR Earlybird " /></p>

<p>En muchos otros casos ademas de alertar se ha encargado de matar el proceso que realizaba la actividad maliciosa.</p>

<p>Ninguna de estas inyecciones, ya sea con binario .EXE o binario .dll, actualmente hace un bypass de crowdstrike, a continuaci√≥n pasaremos a realizar un proyecto con <code class="language-plaintext highlighter-rouge">dll reflectivas</code> (Toda una movida).</p>

<p><a href="./">back</a></p>

      </section>
    </div>
  </body>
</html>
